{"version":3,"sources":["node_modules/browser-pack/_prelude.js","skaryna.min.js","src/browser.js","src/document.js","src/editor.js","src/emitter.js","src/index.js","src/injector.js","src/parser.js","src/parser/fromHTML.js","src/parser/fromPOM.js","src/repository.js","src/serializer.js","src/serializer/toHTML.js","src/toolbar.js","src/util.js","src/xhr.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length","1","module","_index","_editor","_repository","_xhr","Skaryna","Editor","repository","XHR","window","Array","isArray","___Skaryna","forEach","callback","apply","./editor","./index","./repository","./xhr","2","_classCallCheck","instance","Constructor","TypeError","_possibleConstructorReturn","self","ReferenceError","_inherits","subClass","superClass","prototype","Object","create","constructor","value","enumerable","writable","configurable","setPrototypeOf","__proto__","escapeRegexp","str","String","replace","bestMatch","list","filter","best","lowest","rule","regexp","RegExp","weight","split","part","match","getById","id","elementMap","getByNode","element","getAttribute","randomID","setValue","possible","text","charAt","Math","floor","random","keys","indexOf","defineProperty","Variants","Fields","StaticBlockNode","Heading","Image","Paragraph","TextNode","Quote","Document","BlockNode","Node","undefined","_get","get","object","property","receiver","Function","desc","getOwnPropertyDescriptor","parent","getPrototypeOf","getter","_createClass","defineProperties","target","props","descriptor","key","protoProps","staticProps","_emitter","_util","_toHTML","_Emitter","this","_this","name","__locked","attrs","error","Emitter","_Node","type","items","_this2","_type","path","elements","index","shift","rest","join","child","isNaN","output","map","item","toJSON","JSON","parse","stringify","toHTML","edit","then","html","innerHTML","arraize","children","appendChild","_BlockNode","_BlockNode2","_Node2","formats","_this5","toString","node","_this6","format","push","slice","textContent","_TextNode","_Node3","source","title","alt","_this8","src","attributes","_TextNode2","level","_this9","min","json","_BlockNode3","arguments","_Node4","data","_this11","_map","clone","_Node5","_this12","_variants","variant","./emitter","./serializer/toHTML","./util","3","_fromHTML","_fromPOM","_document","_toolbar","_injector","ENTER","PREVENT","toolbar","Toolbar","injector","styles","documentPath","document","DEFAULT_DOCUMENT","_pendingState","_rendering","init","editor","inited","Promise","all","querySelectorAll","factory","documentBody","documentId","set","content","fromPOM","fromHTML","lock","has","doc","empty","render","console","log","stack","caretOffset","ownerDocument","win","defaultView","parentWindow","sel","getSelection","rangeCount","range","getRangeAt","preCaretRange","cloneRange","selectNodeContents","setEnd","endContainer","endOffset","selection","textRange","createRange","preCaretTextRange","body","createTextRange","moveToElementText","setEndPoint","focusNode","getEditableNode","hasAttribute","parentNode","selectorORElement","eventName","myMethod","HTMLElement","addEventListener","event","promise","decorate","resolve","setAttribute","onKeyUp","onDOM","focus","anchor","_this3","focusedNode","newItems","injectorObject","allowedNewItems","hideInjector","showInjector","lastChild","on","splice","afterNode","possibleItems","Injector","box","getBoundingClientRect","injectorBox","setTimeout","style","top","left","width","removeChild","textNode","getCurrentElement","to","from","getCaretCharacterOffsetWithin","POM","HTML","currentTarget","defaultNewItem","newElement","htmlElement","editNode","setStart","collapse","removeAllRanges","addRange","newItem","keyCode","stopPropagation","preventDefault","ownAction","createElement","innerText","./document","./injector","./parser/fromHTML","./parser/fromPOM","./toolbar","4","execute","config","fn","context","args","params","concat","Event","handler","once","__listeners","getListeners","off","toEmitter","emit","result","5","6","SVGS","paragraph","image","dimensions","allowedNodes","div","firstChild","action","svg","createElementNS","7","Parser","token","options","handle","reject","_handlers","parser","8","whatWrapper","rootNode","processChildren","childNodes","nodeType","absoluteEmpty","input","wrapper","toLowerCase","InlineNode","_stringify","_stringify2","_slicedToArray","first","append","_parser","nodeName","formatType","href","_stringify3","_stringify4","innerFormats","otherFormat","idx","heading","_stringify5","_stringify6","_stringify7","_stringify8","attribute","ifAttr","quote","paragraphs","lastParagraph","_stringify9","_stringify10","_stringify11","_stringify12","sliceIterator","arr","_arr","_n","_d","_e","_s","_i","Symbol","iterator","next","done","err","./../document","./../parser","./../util","9","model","processChildNodes","fields","variants","10","CHANGE","Repository","_documents","11","Serializer","array","serialize","serializer","12","_serializer","string","slices","char","tag","handleContents","nodeValue","elem","attributeName","FakeDoc","outerHTML","contents","attr","createTextNode","./../serializer","13","arrow","querySelector","theWindow","rects","rect","x","y","boundingLeft","boundingTop","getClientRects","span","insertNode","spanParent","normalize","coords","getSelectionCoords","display","visibility","show","height","14","iterable","inputs","except","_typeof","obj","15","method","raw","xhr","XMLHttpRequest","httpMethod","open","setRequestHeader","onreadystatechange","DONE","OK","readyState","status","responseText","send","ajax"],"mappings":"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","file":"skaryna.min.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n'use strict';\n\nvar _index = require('./index');\n\nvar _editor = require('./editor');\n\nvar _repository = require('./repository');\n\nvar _xhr = require('./xhr');\n\n/* jslint esnext:true, node:true, browser:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\n_index.Skaryna.Editor = _editor.Editor;\n_index.Skaryna.repository = _repository.repository;\n_index.Skaryna.XHR = _xhr.XHR;\n\nwindow.Skaryna = _index.Skaryna;\n\nif (Array.isArray(window.___Skaryna)) {\n    window.___Skaryna.forEach(function (callback) {\n        callback.apply(window);\n    });\n}\n\n},{\"./editor\":3,\"./index\":5,\"./repository\":10,\"./xhr\":15}],2:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.Variants = exports.Fields = exports.StaticBlockNode = exports.Heading = exports.Image = exports.Paragraph = exports.TextNode = exports.Quote = exports.Document = exports.BlockNode = exports.Node = undefined;\n\nvar _get = function get(object, property, receiver) { if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { return get(parent, property, receiver); } } else if (\"value\" in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } };\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nexports.escapeRegexp = escapeRegexp;\nexports.bestMatch = bestMatch;\nexports.getById = getById;\nexports.getByNode = getByNode;\nexports.randomID = randomID;\n\nvar _emitter = require('./emitter');\n\nvar _util = require('./util');\n\nvar _toHTML = require('./serializer/toHTML');\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; } /* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nvar elementMap = {};\n\n/**\n * @see https://github.com/component/escape-regexp\n * @param   {string} str\n * @returns {string}\n */\nfunction escapeRegexp(str) {\n    return String(str).replace(/([.*+?=^!:${}()|[\\]\\/\\\\])/g, '\\\\$1');\n}\n\n/**\n * @see https://github.com/sielay/bestmatch\n * @param   {array} list\n * @param   {string}   filter\n * @returns {string}\n */\nfunction bestMatch(list, filter) {\n    var lowest = null,\n        best;\n\n    list.forEach(function (rule) {\n        var regexp = new RegExp(escapeRegexp(rule).replace(/\\\\\\*/g, '(.+)')),\n            weight = rule.split('*').filter(function (part) {\n            return part.length;\n        }).length,\n            match = filter.match(regexp);\n\n        if (match && (lowest === null || match.length - weight < lowest)) {\n            lowest = match.length - weight;\n            best = rule;\n        }\n    });\n    return best;\n}\n\nfunction getById(id) {\n    return elementMap[id];\n}\n\nfunction getByNode(element) {\n    if (!element) {\n        return null;\n    }\n    var id = element.getAttribute('data-skaryna-id');\n    return getById(id);\n}\n\nfunction randomID(setValue) {\n    var possible = 'abcdefghijklmnopqrstuvwxyz0123456789',\n        text = '';\n\n    for (var i = 0; i < 5; i++) {\n        text += possible.charAt(Math.floor(Math.random() * possible.length));\n    }\n\n    if (Object.keys(elementMap).indexOf(text) === -1) {\n        elementMap[text] = elementMap[text] || setValue;\n        return text;\n    }\n    return randomID(setValue);\n}\n\n/**\n * @class\n */\n\nvar Node = exports.Node = function (_Emitter) {\n    _inherits(Node, _Emitter);\n\n    /**\n     * @constructs Node\n     */\n\n    function Node() {\n        _classCallCheck(this, Node);\n\n        var _this = _possibleConstructorReturn(this, Object.getPrototypeOf(Node).call(this));\n\n        _this.name = randomID(_this);\n\n        _this.__locked = false;\n        return _this;\n    }\n\n    _createClass(Node, [{\n        key: 'lock',\n        value: function lock() {\n            this.__locked = true;\n        }\n    }, {\n        key: 'attr',\n        value: function attr() {\n            return this.attrs;\n        }\n    }, {\n        key: 'get',\n        value: function get() {\n            throw new Error('Should be implemented');\n        }\n\n        /**\n         * @abstract\n         * @throws {Error}\n         */\n\n    }, {\n        key: 'toJSON',\n        value: function toJSON() {\n            var error = new Error('Should be implemented');\n            throw error;\n        }\n    }, {\n        key: 'locked',\n        get: function get() {\n            return this.__locked;\n        }\n    }, {\n        key: 'defaultNewItem',\n        get: function get() {\n            return null;\n        }\n    }, {\n        key: 'allowedNewItems',\n        get: function get() {\n            return [];\n        }\n    }]);\n\n    return Node;\n}(_emitter.Emitter);\n\n/**\n * @class\n * Defined for Image, Video, Embed, Table, HorizonalRule, Table, List or Component\n */\n\n\nvar BlockNode = exports.BlockNode = function (_Node) {\n    _inherits(BlockNode, _Node);\n\n    function BlockNode(type, items, attrs) {\n        _classCallCheck(this, BlockNode);\n\n        var _this2 = _possibleConstructorReturn(this, Object.getPrototypeOf(BlockNode).call(this));\n\n        _this2._type = type;\n        _this2.items = items || [];\n        _this2.attrs = attrs;\n        return _this2;\n    }\n\n    _createClass(BlockNode, [{\n        key: 'get',\n        value: function get(path) {\n            var elements = path.split('.'),\n                index = elements.shift(),\n                rest = elements.join('.'),\n                child = void 0;\n\n            if (isNaN(index)) {\n                return null;\n            }\n\n            child = this.items[+index];\n\n            if (rest.length && child) {\n                return child.get(rest);\n            }\n\n            return child;\n        }\n    }, {\n        key: 'toJSON',\n        value: function toJSON() {\n            var output = {\n                type: this.type,\n                items: this.items.map(function (item) {\n                    return item.toJSON();\n                })\n            };\n            if (this.attrs) {\n                output.attrs = JSON.parse(JSON.stringify(this.attrs));\n            }\n            return output;\n        }\n    }, {\n        key: 'decorate',\n        value: function decorate(element) {\n            return (0, _toHTML.toHTML)(this, {\n                edit: true\n            }).then(function (html) {\n                element.innerHTML = '';\n                (0, _util.arraize)(html.children).forEach(function (child) {\n                    element.appendChild(child);\n                });\n            });\n        }\n    }, {\n        key: 'empty',\n        get: function get() {\n            return this.items.length <= 0;\n        }\n    }, {\n        key: 'type',\n        get: function get() {\n            return this._type;\n        }\n    }]);\n\n    return BlockNode;\n}(Node);\n\nvar Document = exports.Document = function (_BlockNode) {\n    _inherits(Document, _BlockNode);\n\n    function Document(items) {\n        _classCallCheck(this, Document);\n\n        return _possibleConstructorReturn(this, Object.getPrototypeOf(Document).call(this, 'document', items));\n    }\n\n    _createClass(Document, [{\n        key: 'defaultNewItem',\n        get: function get() {\n            return Paragraph;\n        }\n    }, {\n        key: 'allowedNewItems',\n        get: function get() {\n            return [Paragraph, Image];\n        }\n    }]);\n\n    return Document;\n}(BlockNode);\n\nvar Quote = exports.Quote = function (_BlockNode2) {\n    _inherits(Quote, _BlockNode2);\n\n    function Quote(items) {\n        _classCallCheck(this, Quote);\n\n        return _possibleConstructorReturn(this, Object.getPrototypeOf(Quote).call(this, 'quote', items));\n    }\n\n    return Quote;\n}(BlockNode);\n\n/**\n * @class\n * Defined for Text, Paragraph, ListItem, Quote and Heading\n */\n\n\nvar TextNode = exports.TextNode = function (_Node2) {\n    _inherits(TextNode, _Node2);\n\n    _createClass(TextNode, [{\n        key: 'attr',\n        value: function attr() {\n            if (this.type === 'text') {\n                return {};\n            }\n            return _get(Object.getPrototypeOf(TextNode.prototype), 'attr', this).call(this);\n        }\n    }, {\n        key: 'type',\n        get: function get() {\n            return 'text';\n        }\n    }, {\n        key: 'empty',\n        get: function get() {\n            return !this.text || !this.text.replace(/^([\\s\\n\\r\\t]+)|([\\s\\n\\r\\t]+)$/, '').length;\n        }\n    }, {\n        key: 'absoluteEmpty',\n        get: function get() {\n            return this.text.length === 0;\n        }\n    }], [{\n        key: 'type',\n        get: function get() {\n            return 'text';\n        }\n    }]);\n\n    function TextNode(text, formats, attrs) {\n        _classCallCheck(this, TextNode);\n\n        var _this5 = _possibleConstructorReturn(this, Object.getPrototypeOf(TextNode).call(this));\n\n        _this5.text = text && text.toString ? text.toString() : '';\n        _this5.formats = formats || null;\n        _this5.attrs = attrs;\n        return _this5;\n    }\n\n    _createClass(TextNode, [{\n        key: 'toJSON',\n        value: function toJSON() {\n            var output = {\n                type: this.type,\n                text: this.text\n            };\n            if (this.formats) {\n                output.formats = JSON.parse(JSON.stringify(this.formats));\n            }\n            if (this.attrs && this.type !== 'text') {\n                output.attrs = JSON.parse(JSON.stringify(this.attrs));\n            }\n            return output;\n        }\n    }, {\n        key: 'append',\n        value: function append(node) {\n            var _this6 = this;\n\n            if (!(node instanceof TextNode)) {\n                throw new Error('Only text nodes can be joined');\n            }\n            if (node.formats) {\n                this.formats = this.formats || [];\n                node.formats.forEach(function (format) {\n                    _this6.formats.push({\n                        slice: [format.slice[0] + _this6.text.length, format.slice[1]],\n                        apply: format.apply\n                    });\n                });\n            }\n            this.text += node.text;\n        }\n    }, {\n        key: 'decorate',\n        value: function decorate(element) {\n            return (0, _toHTML.toHTML)(this, {\n                edit: true\n            }).then(function (html) {\n                element.innerHTML = html.textContent;\n            });\n        }\n    }]);\n\n    return TextNode;\n}(Node);\n\nvar Paragraph = exports.Paragraph = function (_TextNode) {\n    _inherits(Paragraph, _TextNode);\n\n    _createClass(Paragraph, [{\n        key: 'type',\n        get: function get() {\n            return 'paragraph';\n        }\n    }], [{\n        key: 'type',\n        get: function get() {\n            return 'paragraph';\n        }\n    }]);\n\n    function Paragraph(text, formats, attrs) {\n        _classCallCheck(this, Paragraph);\n\n        return _possibleConstructorReturn(this, Object.getPrototypeOf(Paragraph).call(this, text, formats, attrs));\n    }\n\n    _createClass(Paragraph, [{\n        key: 'nextNodeType',\n        get: function get() {\n            return Paragraph;\n        }\n    }]);\n\n    return Paragraph;\n}(TextNode);\n\nvar Image = exports.Image = function (_Node3) {\n    _inherits(Image, _Node3);\n\n    function Image(source, title, alt) {\n        _classCallCheck(this, Image);\n\n        var _this8 = _possibleConstructorReturn(this, Object.getPrototypeOf(Image).call(this, 'image'));\n\n        _this8.src = source;\n        _this8.title = title;\n        _this8.alt = alt;\n        return _this8;\n    }\n\n    _createClass(Image, [{\n        key: 'attr',\n        value: function attr() {\n            var attributes = _get(Object.getPrototypeOf(Image.prototype), 'attr', this).call(this) || {};\n            if (this.src) {\n                attributes.src = this.src;\n            }\n            if (this.title) {\n                attributes.title = this.title;\n            }\n            if (this.alt) {\n                attributes.alt = this.title;\n            }\n            return attributes;\n        }\n    }, {\n        key: 'toJSON',\n        value: function toJSON() {\n            var output = {\n                type: 'image',\n                src: this.src\n            };\n            if (this.title) {\n                output.title = this.title;\n            }\n            if (this.alt) {\n                output.alt = this.alt;\n            }\n            return output;\n        }\n    }, {\n        key: 'type',\n        get: function get() {\n            return 'image';\n        }\n    }], [{\n        key: 'type',\n        get: function get() {\n            return 'image';\n        }\n    }]);\n\n    return Image;\n}(Node);\n\nvar Heading = exports.Heading = function (_TextNode2) {\n    _inherits(Heading, _TextNode2);\n\n    function Heading(level, text, formats, attrs) {\n        _classCallCheck(this, Heading);\n\n        var _this9 = _possibleConstructorReturn(this, Object.getPrototypeOf(Heading).call(this, text, formats, attrs));\n\n        _this9.level = Math.min(6, level || 0);\n        return _this9;\n    }\n\n    _createClass(Heading, [{\n        key: 'attr',\n        value: function attr() {\n            return _get(Object.getPrototypeOf(Heading.prototype), 'attr', this).call(this);\n        }\n    }, {\n        key: 'toJSON',\n        value: function toJSON() {\n            var json = _get(Object.getPrototypeOf(Heading.prototype), 'toJSON', this).call(this);\n            json.level = this.level;\n            return json;\n        }\n    }, {\n        key: 'type',\n        get: function get() {\n            return 'heading';\n        }\n    }], [{\n        key: 'type',\n        get: function get() {\n            return 'heading';\n        }\n    }]);\n\n    return Heading;\n}(TextNode);\n\nvar StaticBlockNode = exports.StaticBlockNode = function (_BlockNode3) {\n    _inherits(StaticBlockNode, _BlockNode3);\n\n    function StaticBlockNode() {\n        _classCallCheck(this, StaticBlockNode);\n\n        return _possibleConstructorReturn(this, Object.getPrototypeOf(StaticBlockNode).apply(this, arguments));\n    }\n\n    _createClass(StaticBlockNode, [{\n        key: 'locked',\n        get: function get() {\n            return true;\n        }\n    }, {\n        key: 'defaultNewItem',\n        get: function get() {\n            return Paragraph;\n        }\n    }, {\n        key: 'allowedNewItems',\n        get: function get() {\n            return [Paragraph, Image];\n        }\n    }]);\n\n    return StaticBlockNode;\n}(BlockNode);\n\nvar Fields = exports.Fields = function (_Node4) {\n    _inherits(Fields, _Node4);\n\n    function Fields(data) {\n        _classCallCheck(this, Fields);\n\n        var _this11 = _possibleConstructorReturn(this, Object.getPrototypeOf(Fields).call(this));\n\n        _this11._map = data;\n        return _this11;\n    }\n\n    _createClass(Fields, [{\n        key: 'get',\n        value: function get(path) {\n            var elements = path.split('.'),\n                index = elements.shift(),\n                rest = elements.join('.'),\n                child = void 0;\n\n            child = this._map[index];\n\n            if (rest.length && child) {\n                return child.get(rest);\n            }\n\n            return child;\n        }\n    }, {\n        key: 'toJSON',\n        value: function toJSON() {\n            return (0, _util.clone)([this._map, {\n                type: 'Fields'\n            }]);\n        }\n    }, {\n        key: 'type',\n        get: function get() {\n            return 'Fields';\n        }\n    }], [{\n        key: 'type',\n        get: function get() {\n            return 'Fields';\n        }\n    }]);\n\n    return Fields;\n}(Node);\n\nvar Variants = exports.Variants = function (_Node5) {\n    _inherits(Variants, _Node5);\n\n    function Variants(data) {\n        _classCallCheck(this, Variants);\n\n        var _this12 = _possibleConstructorReturn(this, Object.getPrototypeOf(Variants).call(this));\n\n        _this12._variants = data;\n        return _this12;\n    }\n\n    _createClass(Variants, [{\n        key: 'best',\n        value: function best(variant) {\n            var best = bestMatch(Object.keys(this._variants), variant);\n            return this._variants[best];\n        }\n    }, {\n        key: 'toJSON',\n        value: function toJSON() {\n            return (0, _util.clone)([this._map, {\n                type: 'Variants'\n            }]);\n        }\n    }, {\n        key: 'type',\n        get: function get() {\n            return 'Variants';\n        }\n    }], [{\n        key: 'type',\n        get: function get() {\n            return 'Variants';\n        }\n    }]);\n\n    return Variants;\n}(Node);\n\n},{\"./emitter\":4,\"./serializer/toHTML\":12,\"./util\":14}],3:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.Editor = undefined;\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nvar _emitter = require('./emitter');\n\nvar _util = require('./util');\n\nvar _repository = require('./repository');\n\nvar _toHTML = require('./serializer/toHTML');\n\nvar _fromHTML = require('./parser/fromHTML');\n\nvar _fromPOM = require('./parser/fromPOM');\n\nvar _xhr = require('./xhr');\n\nvar _document = require('./document');\n\nvar _toolbar = require('./toolbar');\n\nvar _injector = require('./injector');\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; } /* jslint esnext:true, node:true, browser:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nvar BACKSPACE = 8,\n    TAB = 9,\n    ENTER = 13,\n    SHIFT = 16,\n    CAPS = 20,\n    ESC = 27,\n    SPACE = 32,\n    UP = 38,\n    DOWN = 40,\n    DELETE = 46,\n    PREVENT = [ENTER];\n\nvar toolbar = new _toolbar.Toolbar(),\n    injector = void 0;\n\n/**\n * @class\n */\n\nvar Editor = exports.Editor = function (_Emitter) {\n    _inherits(Editor, _Emitter);\n\n    _createClass(Editor, null, [{\n        key: 'factory',\n\n\n        /**\n         * [[Description]]\n         * @param {HTMLElement} element\n         * @returns {Promise} [[Description]]\n         */\n        value: function factory(element) {\n            var editor = new Editor(element);\n            return editor.inited;\n        }\n\n        /**\n         * [[Description]]\n         * @param {HTMLElement} element\n         * @returns {Promise} [[Description]]\n         */\n\n    }, {\n        key: 'initEditors',\n        value: function initEditors(element) {\n            return Promise.all((0, _util.arraize)(element.querySelectorAll('[data-skaryna]')).map(function (element) {\n                return Editor.factory(element);\n            }));\n        }\n\n        /**\n         * [[Description]]\n         * @param {Object} documentBody [[Description]]\n         * @param {[[Type]]} documentId   [[Description]]\n         */\n\n    }, {\n        key: 'registerDocument',\n        value: function registerDocument(documentBody, documentId) {\n            _repository.repository.set(documentId || _repository.DEFAULT_DOCUMENT, documentBody);\n        }\n\n        /**\n         * Loads data from REST endpoint\n         * @param   {string} path\n         * @param   {string} documentId\n         * @returns {Promise}\n         */\n\n    }, {\n        key: 'load',\n        value: function load(path, documentId) {\n            return _xhr.XHR.get(path).then(function (content) {\n                return (0, _fromPOM.fromPOM)(JSON.parse(content));\n            }).then(function (content) {\n                _repository.repository.set(documentId || _repository.DEFAULT_DOCUMENT, content);\n            });\n        }\n\n        /**\n         * @param {HTMLElement} element\n         */\n\n    }]);\n\n    function Editor(element) {\n        _classCallCheck(this, Editor);\n\n        var _this = _possibleConstructorReturn(this, Object.getPrototypeOf(Editor).call(this));\n\n        _this.element = element;\n        _this.documentPath = element.getAttribute('data-skaryna-path') || null;\n        _this.document = element.getAttribute('data-skaryna-doc') || _repository.DEFAULT_DOCUMENT;\n        _this.variant = element.getAttribute('data-skaryna-variant') || null;\n\n        _this._pendingState = null;\n        _this._rendering = false;\n\n        _this.init();\n\n        return _this;\n    }\n\n    /**\n     * Inits component\n     * @returns {Promise}\n     */\n\n\n    _createClass(Editor, [{\n        key: 'init',\n        value: function init() {\n            var self = this;\n            if (this.inited) {\n                return this.inited;\n            }\n            this.inited = (0, _fromHTML.fromHTML)(this.element, {\n                edit: true\n            }).then(function (content) {\n                content.lock();\n                if (_repository.repository.has(self.document)) {\n                    var doc = _repository.repository.get(self.document);\n                    if (self.documentPath) {\n                        doc = doc.get(self.documentPath);\n                        if (doc && doc.type === 'Variants' && doc.best) {\n                            doc = doc.best(self.variant || '*');\n                        }\n                    }\n                    self.content = doc;\n                } else if (!content.empty) {\n                    _repository.repository.set(self.document, content);\n                    self.content = content;\n                }\n            }).then(function () {\n                self.render();\n            }).catch(function (error) {\n                console.log(error);\n                console.log(error.stack);\n            });\n        }\n    }, {\n        key: 'getCaretCharacterOffsetWithin',\n        value: function getCaretCharacterOffsetWithin(element) {\n            var caretOffset = 0,\n                doc = element.ownerDocument || element.document,\n                win = doc.defaultView || doc.parentWindow,\n                sel = void 0;\n            if (typeof win.getSelection != 'undefined') {\n                sel = win.getSelection();\n                if (sel.rangeCount > 0) {\n                    var range = win.getSelection().getRangeAt(0),\n                        preCaretRange = range.cloneRange();\n                    preCaretRange.selectNodeContents(element);\n                    preCaretRange.setEnd(range.endContainer, range.endOffset);\n                    caretOffset = preCaretRange.toString().length;\n                }\n            } else if ((sel = doc.selection) && sel.type != 'Control') {\n                var textRange = sel.createRange(),\n                    preCaretTextRange = doc.body.createTextRange();\n                preCaretTextRange.moveToElementText(element);\n                preCaretTextRange.setEndPoint('EndToEnd', textRange);\n                caretOffset = preCaretTextRange.text.length;\n            }\n            return caretOffset;\n        }\n    }, {\n        key: 'getSelectionLength',\n        value: function getSelectionLength(element) {}\n    }, {\n        key: 'getCurrentElement',\n        value: function getCurrentElement(element) {\n\n            var doc = element.ownerDocument || element.document,\n                win = doc.defaultView || doc.parentWindow,\n                sel = void 0,\n                node = void 0;\n\n            if (typeof win.getSelection != 'undefined') {\n                sel = win.getSelection();\n            } else {\n                sel = doc.selection;\n            }\n\n            node = sel.focusNode;\n\n            if (node === this.element) {\n                return this.element;\n            }\n            return this.getEditableNode(node);\n        }\n    }, {\n        key: 'getEditableNode',\n        value: function getEditableNode(node) {\n            while (node && (!node.hasAttribute || !node.hasAttribute('data-skaryna-id'))) {\n                node = node.parentNode;\n            }\n            return node;\n        }\n    }, {\n        key: 'onDOM',\n        value: function onDOM(selectorORElement, eventName, myMethod) {\n            var self = this;\n            if (selectorORElement instanceof HTMLElement) {\n                selectorORElement = [selectorORElement];\n            } else {\n                selectorORElement = (0, _util.arraize)(this.element.querySelectorAll(selectorORElement));\n            }\n            selectorORElement.forEach(function (element) {\n                element.addEventListener(eventName, function (event) {\n                    myMethod.apply(self, [event]);\n                }, true);\n            });\n        }\n\n        /**\n         * Renders UI\n         * @returns {Promise}\n         */\n\n    }, {\n        key: 'render',\n        value: function render() {\n            var _this2 = this;\n\n            this._rendering = true;\n            var self = this,\n                promise = void 0;\n\n            if (!this.content) {\n                this._rendering = false;\n                promise = Promise.resolve();\n            } else {\n                promise = this.content.decorate(this.element).then(function () {\n                    _this2._rendering = false;\n                });\n            }\n\n            return promise.then(function () {\n                self.element.setAttribute('data-skaryna-id', self.content ? self.content.name : (0, _document.randomID)(true));\n                self.element.setAttribute('contentEditable', '');\n                self.element.addEventListener('keydown', function (event) {\n                    self.onKeyUp(event);\n                }, true);\n                self.onDOM('[data-skaryna-id]', 'mouseup', self.focus);\n                self.onDOM(self.element, 'mouseup', self.focus);\n                /*\n                    self.element.addEventListener('mouseup', (event) => {\n                        let sel = window.getSelection ? window.getSelection().toString() : document.selection.createRange().text;\n                        if (sel && sel.length) {\n                            self.onSelect(event);\n                        }\n                    }, true);*/\n            });\n        }\n    }, {\n        key: 'onSelect',\n        value: function onSelect(event) {\n\n            /*this.showToolbar();\n            this.strong();*/\n        }\n    }, {\n        key: 'showToolbar',\n        value: function showToolbar() {\n            toolbar.anchor();\n        }\n    }, {\n        key: 'focus',\n        value: function focus(event) {\n            var _this3 = this;\n\n            var node = this.getEditableNode(event.target),\n                focusedNode = (0, _document.getByNode)(node),\n                parentNode = (0, _document.getByNode)(node.parentNode),\n                newItems = void 0,\n                injectorObject = void 0;\n\n            newItems = parentNode ? parentNode.allowedNewItems : focusedNode.allowedNewItems;\n\n            this.hideInjector();\n\n            if (newItems.length > 0) {\n                if (!parentNode) {\n                    injectorObject = this.showInjector(node.parentNode.lastChild, newItems);\n                } else {\n                    injectorObject = this.showInjector(node, newItems);\n                }\n                injectorObject.on('injectnode', function (event) {\n                    if (parentNode) {\n                        var index = parentNode.items.indexOf(focusedNode);\n                        parentNode.items.splice(index, 0, new event.data());\n                    } else {\n                        parentNode.items.push(new event.data());\n                    }\n                    _this3.render();\n                });\n            }\n        }\n    }, {\n        key: 'showInjector',\n        value: function showInjector(afterNode, possibleItems) {\n            var injectorObject = new _injector.Injector(possibleItems),\n                box = afterNode.getBoundingClientRect(),\n                injectorBox = void 0;\n\n            injector = injectorObject.element;\n            document.body.appendChild(injector);\n            setTimeout(function () {\n                injectorBox = injector.getBoundingClientRect();\n                injector.style.top = box.top + 'px';\n                injector.style.left = box.left - injectorBox.width + 'px';\n            }, 0);\n            return injectorObject;\n        }\n    }, {\n        key: 'hideInjector',\n        value: function hideInjector() {\n            if (injector) {\n                if (injector.parentNode) {\n                    injector.parentNode.removeChild(injector);\n                }\n                injector = null;\n            }\n        }\n    }, {\n        key: 'strong',\n        value: function strong() {\n            var textNode = this.getCurrentElement(event.target),\n                sel = window.getSelection ? window.getSelection().toString() : document.selection.createRange().text,\n                to = sel.length,\n                from = this.getCaretCharacterOffsetWithin(textNode) - to;\n\n            (0, _fromHTML.fromHTML)(textNode).then(function (POM) {\n                POM.formats = POM.formats || [];\n                POM.formats.push({\n                    slice: [from, to],\n                    apply: ['strong']\n                });\n                return (0, _toHTML.toHTML)(POM);\n            }).then(function (HTML) {\n                textNode.innerHTML = HTML.innerHTML;\n            });\n        }\n\n        /**\n         * Handles external change\n         * @param {object} event\n         */\n\n    }, {\n        key: 'onExternalChange',\n        value: function onExternalChange(event) {\n            if (this._rendering) {\n                this._pendingState = true;\n                return;\n            }\n            this.render();\n        }\n    }, {\n        key: 'newItem',\n        value: function newItem(target) {\n            var currentTarget = target,\n                node = (0, _document.getByNode)(currentTarget),\n                self = this;\n            while (node !== null) {\n                if (!node) {\n                    return;\n                }\n                if (node.defaultNewItem) {\n                    var newElement = new node.defaultNewItem();\n                    node.items.push(newElement);\n\n                    (0, _toHTML.toHTML)(newElement, {\n                        edit: true\n                    }).then(function (htmlElement) {\n                        currentTarget.appendChild(htmlElement);\n                        self.editNode(htmlElement);\n                    });\n                    return;\n                }\n                currentTarget = currentTarget.parentNode;\n                node = (0, _document.getByNode)(currentTarget);\n            }\n        }\n    }, {\n        key: 'editNode',\n        value: function editNode(node) {\n            var range = document.createRange(),\n                sel = window.getSelection();\n            range.setStart(node, 0);\n            range.collapse(true);\n            sel.removeAllRanges();\n            sel.addRange(range);\n        }\n    }, {\n        key: 'ownAction',\n        value: function ownAction(key, target) {\n            if (key === ENTER) {\n                return this.newItem(target);\n            }\n        }\n\n        /**\n         * Handles key up event\n         * @param {Event} event\n         */\n\n    }, {\n        key: 'onKeyUp',\n        value: function onKeyUp(event) {\n\n            if (PREVENT.indexOf(event.keyCode) !== -1) {\n                event.stopPropagation();\n                event.preventDefault();\n                this.ownAction(event.keyCode, this.getCurrentElement(event.target));\n            }\n        }\n    }]);\n\n    return Editor;\n}(_emitter.Emitter);\n\nvar styles = document.createElement('style');\nstyles.innerText = '\\n        p[data-skaryna-id]:empty {\\n                display: block;\\n                height: 1em;\\n            }\\n        }\\n        ';\n\ndocument.body.appendChild(styles);\n\n},{\"./document\":2,\"./emitter\":4,\"./injector\":6,\"./parser/fromHTML\":8,\"./parser/fromPOM\":9,\"./repository\":10,\"./serializer/toHTML\":12,\"./toolbar\":13,\"./util\":14,\"./xhr\":15}],4:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\n/**\n * @namespace skaryna\n *\n * @class EventConfig\n * @property {function} fn listener\n * @property {object} context\n * @property {array} args arguments to be passed\n * @property {boolean} once if should be fired only once\n */\n\n/**\n * @class Event\n */\n\nvar Event = exports.Event = function () {\n    /**\n     * Contructor\n     * @constructs Event\n     * @param {string} name\n     * @param {mixed} data\n     * @param {object} source\n     * @param {Event} parent\n     */\n\n    function Event(name, data, source, parent) {\n        _classCallCheck(this, Event);\n\n        Object.defineProperties(this, {\n            /**\n             * @property {string}\n             * @name Event#name\n             */\n            name: {\n                value: name,\n                writable: false\n            },\n            /**\n             * @property {mixed}\n             * @name Event#data\n             */\n            data: {\n                value: data,\n                writable: false\n            },\n            /**\n             * @property {object}\n             * @name Event#source\n             */\n            source: {\n                value: source,\n                writable: false\n            },\n            /**\n             * @property {Event|null}\n             * @name Event#parent\n             */\n            parent: {\n                value: parent,\n                writable: false\n            }\n        });\n    }\n\n    _createClass(Event, [{\n        key: 'toJSON',\n        value: function toJSON() {\n            return {\n                name: this.name,\n                data: this.data,\n                source: this.source,\n                parent: this.parent\n            };\n        }\n    }, {\n        key: 'toString',\n        value: function toString() {\n            return 'Event: ' + JSON.stringify(this.toJSON());\n        }\n    }]);\n\n    return Event;\n}();\n\n/**\n * [[Description]]\n * @param {Event} cofnig\n * @param {EventConfig} thisObject\n */\n\n\nfunction execute(event, config) {\n    var fn = config.fn;\n    var context = config.context;\n    var args = config.args;\n    var params = [event].concat(args);\n\n    fn.apply(context || null, params);\n}\n\n/*\n * @class Emitter\n */\n\nvar Emitter = exports.Emitter = function () {\n    function Emitter() {\n        _classCallCheck(this, Emitter);\n    }\n\n    _createClass(Emitter, [{\n        key: 'on',\n\n\n        /**\n         * Adds listener for an event\n         * @param {string} eventName\n         * @param {function} handler\n         * @param {object} context\n         * @param {array} args\n         * @param {boolean} once\n         */\n        value: function on(eventName, handler, context, args, once) {\n            this.__listeners = this.__listeners || {};\n            this.__listeners[eventName] = this.__listeners[eventName] || [];\n            this.__listeners[eventName].push({\n                fn: handler,\n                context: context,\n                args: args,\n                once: !!once\n            });\n        }\n\n        /**\n         * Adds listener for an event that should be called once\n         * @param {string} eventName\n         * @param {function} handler\n         * @param {object} context\n         * @param {array} args\n         */\n\n    }, {\n        key: 'once',\n        value: function once(eventName, handler, context, args) {\n            this.on(eventName, handler, context, args, true);\n        }\n\n        /**\n         * Adds listener for an event\n         * @param {string} eventName\n         * @param {function} handler\n         * @param {object} context\n         * @param {array} args\n         * @param {boolean} once\n         */\n\n    }, {\n        key: 'off',\n        value: function off(eventName, handler, context, args, once) {\n            var _this = this;\n\n            if (!this.__listeners || !this.__listeners[eventName]) {\n                return;\n            }\n            this.getListeners(eventName, handler, context, args, once).forEach(function (config) {\n                _this.__listeners[eventName].splice(_this.__listeners[eventName].indexOf(config), 1);\n            });\n        }\n\n        /**\n         * Emits an event\n         * @param {string} eventName\n         * @param {mixed} data\n         * @param {Event|null} parent\n         */\n\n    }, {\n        key: 'emit',\n        value: function emit(eventName, data, parent) {\n            if (!this.__listeners || !this.__listeners[eventName]) {\n                return;\n            }\n\n            var self = this,\n                event = new Event(eventName, data, this, parent);\n\n            this.getListeners(eventName).forEach(function (config) {\n                if (config.once === true) {\n                    self.off(eventName, config.fn, config.context, config.args, config.once);\n                }\n                execute(event, config);\n            });\n        }\n\n        /**\n         * Bubbles event to other emitter\n         * @param {string} eventName\n         * @param {object} toEmitter\n         */\n\n    }, {\n        key: 'bubbleEvent',\n        value: function bubbleEvent(eventName, toEmitter) {\n            this.on(eventName, function (event) {\n                toEmitter.emit(eventName, event.data, event);\n            });\n        }\n\n        /**\n         * Gets all listeners that match criteria\n         * @param   {string} eventName required\n         * @param   {function} handler   if defined will be used for match\n         * @param   {object} context   if defined will be used for match\n         * @param   {array} args      if defined will be used for match\n         * @returns {array<EventConfig>|null}\n         */\n\n    }, {\n        key: 'getListeners',\n        value: function getListeners(eventName, handler, context, args) {\n            if (!this.__listeners || !this.__listeners[eventName]) {\n                return null;\n            }\n\n            return this.__listeners[eventName].map(function (config) {\n                if (handler !== undefined && config.fn !== handler) {\n                    return false;\n                }\n                if (context !== undefined && config.context !== context) {\n                    return false;\n                }\n                if (args !== undefined && config.args !== args) {\n                    return false;\n                }\n                return config;\n            }).filter(function (result) {\n                return !!result;\n            });\n        }\n    }]);\n\n    return Emitter;\n}();\n\n},{}],5:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _emitter = require('./emitter');\n\nObject.defineProperty(exports, 'Event', {\n    enumerable: true,\n    get: function get() {\n        return _emitter.Event;\n    }\n});\nObject.defineProperty(exports, 'Emitter', {\n    enumerable: true,\n    get: function get() {\n        return _emitter.Emitter;\n    }\n});\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar Skaryna = exports.Skaryna = function Skaryna() {\n    _classCallCheck(this, Skaryna);\n};\n\n},{\"./emitter\":4}],6:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.Injector = undefined;\n\nvar _emitter = require('./emitter');\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; } /* jslint esnext:true, node:true, browser:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\n\nvar styles = void 0;\n\nvar SVGS = {\n    paragraph: 'M832 320v704q0 104-40.5 198.5t-109.5 163.5-163.5 109.5-198.5 40.5h-64q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h64q106 0 181-75t75-181v-32q0-40-28-68t-68-28h-224q-80 0-136-56t-56-136v-384q0-80 56-136t136-56h384q80 0 136 56t56 136zm896 0v704q0 104-40.5 198.5t-109.5 163.5-163.5 109.5-198.5 40.5h-64q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h64q106 0 181-75t75-181v-32q0-40-28-68t-68-28h-224q-80 0-136-56t-56-136v-384q0-80 56-136t136-56h384q80 0 136 56t56 136z',\n    image: 'M576 576q0 80-56 136t-136 56-136-56-56-136 56-136 136-56 136 56 56 136zm1024 384v448h-1408v-192l320-320 160 160 512-512zm96-704h-1600q-13 0-22.5 9.5t-9.5 22.5v1216q0 13 9.5 22.5t22.5 9.5h1600q13 0 22.5-9.5t9.5-22.5v-1216q0-13-9.5-22.5t-22.5-9.5zm160 32v1216q0 66-47 113t-113 47h-1600q-66 0-113-47t-47-113v-1216q0-66 47-113t113-47h1600q66 0 113 47t47 113z',\n    dimensions: '0 0 1792 1792'\n};\n\nvar Injector = exports.Injector = function (_Emitter) {\n    _inherits(Injector, _Emitter);\n\n    function Injector(allowedNodes) {\n        _classCallCheck(this, Injector);\n\n        var _this = _possibleConstructorReturn(this, Object.getPrototypeOf(Injector).call(this));\n\n        var self = _this,\n            div = document.createElement('div');\n\n        div.innerHTML = '<div data-skaryna-tooltip=\"left\"><div></div><div></div></div>';\n\n        _this.element = div.firstChild;\n\n        allowedNodes.forEach(function (node) {\n            var action = document.createElement('a'),\n                svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg'),\n                path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\n\n            svg.setAttribute('width', 30);\n            svg.setAttribute('height', 30);\n            svg.setAttribute('viewBox', SVGS.dimensions);\n            svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');\n            path.setAttribute('d', SVGS[node.type]);\n            path.setAttribute('fill', '#fff');\n\n            svg.appendChild(path);\n            action.appendChild(svg);\n\n            action.addEventListener('mousedown', function (event) {\n                event.preventDefault();\n                event.stopPropagation();\n                console.log(node);\n                self.emit('injectnode', node);\n            }, true);\n            _this.element.children[1].appendChild(action);\n        });\n\n        if (!styles) {\n            styles = document.createElement('style');\n            styles.innerText = '\\n        [data-skaryna-tooltip] {\\n            position: absolute;\\n            z-index: 1070;\\n            display: block;\\n            font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif;\\n            font-size: 12px;\\n            font-style: normal;\\n            font-weight: 400;\\n            line-height: 1.42857143;\\n            text-align: left;\\n            text-align: start;\\n            text-decoration: none;\\n            text-shadow: none;\\n            text-transform: none;\\n            letter-spacing: normal;\\n            word-break: normal;\\n            word-spacing: normal;\\n            word-wrap: normal;\\n            white-space: normal;\\n            /*filter: alpha(opacity=0);\\n            opacity: 0;*/\\n            line-break: auto;\\n            transition: opacity 0.5s;\\n        }\\n        [data-skaryna-tooltip] div:nth-child(2) {\\n            max-width: 200px;\\n            padding: 3px 8px;\\n            color: #fff;\\n            text-align: center;\\n            background-color: #000;\\n            border-radius: 4px;\\n        }\\n        [data-skaryna-tooltip] div:nth-child(1) {\\n            position: absolute;\\n            width: 0;\\n            height: 0;\\n            border-color: transparent;\\n            border-style: solid;\\n        }\\n        [data-skaryna-tooltip=\"left\"] {\\n            padding: 0 5px;\\n            margin-left: -3px;\\n        }\\n        [data-skaryna-tooltip=\"top\"] {\\n            padding: 5px 0;\\n            margin-top: -3px;\\n        }\\n        [data-skaryna-tooltip=\"bottom\"] {\\n            padding: 5px 0;\\n            margin-top: 3px;\\n        }\\n        [data-skaryna-tooltip=\"right\"] {\\n            padding: 0 5px;\\n            margin-left: 3px;\\n        }\\n        [data-skaryna-tooltip=\"left\"] div:nth-child(1) {\\n            top: 50%;\\n            right: 0;\\n            margin-top: -5px;\\n            border-width: 5px 0 5px 5px;\\n            border-left-color: #000;\\n        }\\n        [data-skaryna-tooltip=\"top\"] div:nth-child(1) {\\n            bottom: 0;\\n            left: 50%;\\n            margin-left: -5px;\\n            border-width: 5px 5px 0;\\n            border-top-color: #000;\\n        }\\n        [data-skaryna-tooltip=\"bottom\"] div:nth-child(1) {\\n            top: 0;\\n            left: 50%;\\n            margin-left: -5px;\\n            border-width: 0 5px 5px;\\n            border-bottom-color: #000;\\n        }\\n        [data-skaryna-tooltip=\"right\"] div:nth-child(1) {\\n            top: 50%;\\n            left: 0;\\n            margin-top: -5px;\\n            border-width: 5px 5px 5px 0;\\n            border-right-color: #000;\\n        }\\n        [data-skaryna-tooltip] a {\\n            margin-left: 10px;\\n        }\\n        [data-skaryna-tooltip] a:first-child{\\n            margin-left: 0px;\\n        }';\n\n            document.body.appendChild(styles);\n        }\n        return _this;\n    }\n\n    return Injector;\n}(_emitter.Emitter);\n\n},{\"./emitter\":4}],7:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nvar Parser = function () {\n    function Parser() {\n        _classCallCheck(this, Parser);\n    }\n\n    _createClass(Parser, [{\n        key: 'parse',\n        value: function parse(format, token, data, options) {\n\n            if (!token) {\n                return Promise.reject(new Error('Model is empty'));\n            }\n\n            return this.handle(format, token, data, options);\n        }\n    }, {\n        key: 'on',\n        value: function on(format, token, handler) {\n            this._handlers = this._handlers || {};\n            this._handlers[format] = this._handlers[format] || {};\n            this._handlers[format][token] = handler;\n        }\n    }, {\n        key: 'handle',\n        value: function handle(format, token, data, options) {\n\n            var handler = this._handlers && this._handlers[format] && this._handlers[format][token] ? this._handlers[format][token] : null;\n            if (!handler) {\n                handler = this._handlers && this._handlers[format] && this._handlers[format]['*'] ? this._handlers[format]['*'] : null;\n                if (!handler) {\n                    return Promise.reject(new Error('No handler defined for ' + format + ' : ' + token));\n                }\n            }\n\n            return handler(token, data, options).then(function (POM) {\n                return POM;\n            });\n        }\n    }]);\n\n    return Parser;\n}();\n\nvar parser = exports.parser = new Parser();\n\n},{}],8:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"]) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); } }; }(); /* jslint esnext:true, node:true */\n/* globals document */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nexports.fromHTML = fromHTML;\n\nvar _parser = require('./../parser');\n\nvar _util = require('./../util');\n\nvar _document = require('./../document');\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }\n\nfunction whatWrapper(rootNode) {\n    switch (rootNode) {\n        case 'td':\n        case 'th':\n            return 'tr';\n        case 'tr':\n            return 'table';\n        default:\n            return 'div';\n    }\n}\n\nfunction editMode(node, element, options) {\n    if (options && options.edit) {\n        element.setAttribute('data-skaryna-id', node.name);\n        node.__element = element;\n    }\n    return node;\n}\n\nfunction processChildren(element, options) {\n    if (!element || !element.childNodes) {\n        return Promise.resolve([]);\n    }\n    return Promise.all((0, _util.arraize)(element.childNodes).map(function (child) {\n        if (child.nodeType === 1 || child.nodeType === 3) {\n            return fromHTML(child, options);\n        } else {\n            return null;\n        }\n    })).then(function (items) {\n        return items.filter(function (item) {\n            if (item.constructor === _document.TextNode) {\n                return !item.absoluteEmpty;\n            }\n            return item !== null;\n        });\n    });\n}\n\n/**\n * Parse POM JSON representation\n * @param   {string|HTMLElement}   model\n * @param   {options} options\n * @returns {Promise<Node>}\n */\nfunction fromHTML(input, options) {\n\n    if (!input) {\n        return Promise.resolve(null);\n    }\n\n    if (typeof input === 'string') {\n        if (input.length === 0) {\n            return Promise.resolve(null);\n        }\n        var wrapper = document.createElement(whatWrapper(input.replace('/^(\\s*)<([a-zA-Z0-9_-]+)', '$2').toLowerCase()));\n        wrapper.innerHTML = input;\n        return processChildren(wrapper, options).then(function (children) {\n\n            if (children.length === 1) {\n                return children[0];\n            }\n            if (children.filter(function (item) {\n                return !(item instanceof _document.TextNode || item instanceof InlineNode);\n            }).length) {\n                if (children.map(function (item) {\n                    return item instanceof _document.BlockNode;\n                }).length) {\n                    return new _document.Document(children.map(function (item) {\n                        if (item.type === 'text') {\n                            return new _document.Paragraph(item.text, item.formats, item.attrs, options);\n                        }\n                        return item;\n                    }));\n                }\n                return new _document.Document(children);\n            }\n            var items = children.map(function (item) {\n                if (item instanceof InlineNode) {\n                    var _stringify = stringify([item]);\n\n                    var _stringify2 = _slicedToArray(_stringify, 2);\n\n                    var text = _stringify2[0];\n                    var formats = _stringify2[1];\n\n                    return new _document.TextNode(text, formats, options);\n                }\n\n                return item;\n            }),\n                first = items.shift();\n            items.forEach(function (item) {\n                first.append(item);\n            });\n            return first;\n        });\n    }\n    return _parser.parser.parse('html', input.nodeType === 3 ? 'text' : input.nodeName, input);\n}\n\nvar InlineNode = function (_BlockNode) {\n    _inherits(InlineNode, _BlockNode);\n\n    function InlineNode() {\n        _classCallCheck(this, InlineNode);\n\n        return _possibleConstructorReturn(this, Object.getPrototypeOf(InlineNode).apply(this, arguments));\n    }\n\n    return InlineNode;\n}(_document.BlockNode);\n\nfunction formatType(item, text) {\n    if (item.type === 'A') {\n        return {\n            type: 'A',\n            title: item.attrs.title || text,\n            href: item.attrs.href\n        };\n    }\n    return item.type;\n}\n\nfunction stringify(items) {\n    var text = '',\n        formats = [],\n        index = 0;\n\n    items.forEach(function (item) {\n        if (item instanceof InlineNode) {\n            var _stringify3 = stringify(item.items);\n\n            var _stringify4 = _slicedToArray(_stringify3, 2);\n\n            var innerText = _stringify4[0];\n            var innerFormats = _stringify4[1];\n            var format = {\n                slice: [index, innerText.length],\n                apply: [formatType(item, innerText)]\n            };\n            formats.push(format);\n            innerFormats.forEach(function (format) {\n                formats.push({\n                    slice: [index + format.slice[0], format.slice[1]],\n                    apply: format.apply\n                });\n            });\n            formats.forEach(function (format) {\n                formats.forEach(function (otherFormat, idx) {\n                    if (format !== otherFormat && format.slice[0] === otherFormat.slice[0] && format.slice[1] === otherFormat.slice[1]) {\n                        format.apply = format.apply.concat(otherFormat.apply);\n                        formats.splice(idx, 1);\n                    }\n                });\n            });\n            text += innerText;\n            index += innerText.length;\n        } else if (item instanceof _document.TextNode) {\n            text += item.text;\n            index += item.text.length;\n        } else {}\n    });\n\n    return [text, formats];\n}\n\nfunction heading(token, data, options) {\n\n    return processChildren(data, options).then(function (items) {\n        var _stringify5 = stringify(items);\n\n        var _stringify6 = _slicedToArray(_stringify5, 2);\n\n        var text = _stringify6[0];\n        var formats = _stringify6[1];\n\n        return Promise.resolve(new _document.Heading(token[1].toLowerCase(), text || '', formats.length ? formats : null, options));\n    });\n}\n\nfunction paragraph(token, data, options) {\n    return processChildren(data, options).then(function (items) {\n        var _stringify7 = stringify(items);\n\n        var _stringify8 = _slicedToArray(_stringify7, 2);\n\n        var text = _stringify8[0];\n        var formats = _stringify8[1];\n\n        return Promise.resolve(new _document.Paragraph(text, formats.length ? formats : null));\n    });\n}\n\nfunction attributes(input) {\n    var output = null;\n    (0, _util.arraize)(input).forEach(function (attribute) {\n        output = output || {};\n        if (attribute.value && attribute.value.length) {\n            output[attribute.name] = attribute.value;\n        }\n    });\n    return output;\n}\n\nfunction ifAttr(value) {\n    if (value && value.length) {\n        return value;\n    }\n    return null;\n}\n\nfunction quote(token, data, options) {\n    return processChildren(data, options).then(function (items) {\n\n        var paragraphs = [],\n            lastParagraph = [];\n        items.forEach(function (item) {\n            if (item instanceof _document.Paragraph) {\n                if (lastParagraph.length) {\n                    var _stringify9 = stringify(items);\n\n                    var _stringify10 = _slicedToArray(_stringify9, 2);\n\n                    var text = _stringify10[0];\n                    var formats = _stringify10[1];\n\n                    paragraphs.push(Promise.resolve(new _document.Paragraph(text, formats.length ? formats : null, options)));\n                    lastParagraph = [];\n                }\n                paragraphs.push(Promise.resolve(item));\n            } else {\n                lastParagraph.push(item);\n            }\n        });\n        if (lastParagraph.length) {\n            var _stringify11 = stringify(items);\n\n            var _stringify12 = _slicedToArray(_stringify11, 2);\n\n            var text = _stringify12[0];\n            var formats = _stringify12[1];\n\n            paragraphs.push(Promise.resolve(new _document.Paragraph(text, formats.length ? formats : null, options)));\n        }\n\n        return Promise.all(paragraphs);\n    }).then(function (items) {\n        return Promise.resolve(new _document.Quote(items));\n    });\n}\n\n_parser.parser.on('html', 'text', function (token, data, options) {\n    return Promise.resolve(new _document.TextNode(data.textContent, null, options));\n});\n_parser.parser.on('html', 'H1', heading);\n_parser.parser.on('html', 'H2', heading);\n_parser.parser.on('html', 'H3', heading);\n_parser.parser.on('html', 'H4', heading);\n_parser.parser.on('html', 'H5', heading);\n_parser.parser.on('html', 'H6', heading);\n_parser.parser.on('html', 'P', paragraph);\n_parser.parser.on('html', 'BLOCKQUOTE', quote);\n\n_parser.parser.on('html', 'IMG', function (token, data, options) {\n    return Promise.resolve(new _document.Image(data.src, ifAttr(data.getAttribute('title')), ifAttr(data.getAttribute('alt')), (0, _util.clone)([attributes(data.attributes)], ['src', 'title', 'alt'])), options);\n});\n\n['ADDRESS', 'ARTICLE', 'ASIDE', 'DIV', 'FIGURE', 'FOOTER', 'HEADER', 'MAIN', 'NAV', 'SECTION'].forEach(function (nodeName) {\n    _parser.parser.on('html', nodeName, function (token, data, options) {\n        return processChildren(data, options).then(function (items) {\n            return Promise.resolve(new _document.StaticBlockNode(token, items, attributes(data.attributes)), options);\n        });\n    });\n});\n\n_parser.parser.on('html', '*', function (token, data, options) {\n    return processChildren(data, options).then(function (items) {\n        return Promise.resolve(new InlineNode(token, items, attributes(data.attributes)), options);\n    });\n});\n/*\nparser.on('html', '#text', (token, data) => {\n    return Promise.resolve(new TextNode(data.textContent));\n});\n\n[\n    ['b', 'strong'],\n    ['big', 'strong'],\n    ['i', 'em'],\n    'small',\n    ['tt', 'code'],\n    ['abbr', 'semantic', 'abbr'],\n    ['acronym', 'abbr', 'abbr'],\n    ['cite', 'semantic', 'cite'],\n    'code',\n    ['dfn', 'semantic', 'definition'],\n    'em',\n    ['time', 'semantic', 'time'],\n    ['var', 'code', 'var'],\n    ['kbd', 'code', 'kbd'],\n    'strong',\n    ['samp', 'code', 'sample'],\n    'bdo',\n    'a',\n    //'br',\n    //'img,\n    //'map',\n    //'object',\n    ['q', 'semantic', 'quotation'],\n    //script\n    'span',\n    del,\n    s\n    'sub',\n    'sup',\n    //button\n    //input\n    //label\n    //select\n    //textarea\n].forEach((inlineRule) => {\n\n    let input = typeof inlineRule === 'string' ? inlineRule : inlineRule[0];\n\n    parser.on('html', input, (token, data) => {\n        return processChildren(data)\n            .then((items) => {\n\n            });\n    });\n\n});\n*/\n\n},{\"./../document\":2,\"./../parser\":7,\"./../util\":14}],9:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.fromPOM = fromPOM;\n\nvar _parser = require('./../parser');\n\nvar _document = require('./../document');\n\n/**\n * Parse POM JSON representation\n * @param   {object}   model\n * @param   {options} options\n * @returns {Promise<Node>}\n */\n/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nfunction fromPOM(model) {\n    if (!model) {\n        return Promise.resolve(null);\n    }\n    return _parser.parser.parse('pom', model.type, model);\n}\n\nfunction processChildNodes(items) {\n    if (!Array.isArray(items)) {\n        return Promise.resolve([]);\n    }\n    return Promise.all(items.map(function (item) {\n        return fromPOM(item);\n    })).then(function (items) {\n        return items.filter(function (item) {\n            return !!item;\n        });\n    });\n}\n\n_parser.parser.on('pom', 'document', function (token, data) {\n    return processChildNodes(data.items).then(function (items) {\n        return new _document.Document(items);\n    });\n});\n\n_parser.parser.on('pom', 'heading', function (token, data) {\n    return Promise.resolve(new _document.Heading(data.level, data.text, data.formats, data.attrs));\n});\n\n_parser.parser.on('pom', 'paragraph', function (token, data) {\n    return Promise.resolve(new _document.Paragraph(data.text, data.formats, data.attrs));\n});\n\n_parser.parser.on('pom', 'text', function (token, data) {\n    return Promise.resolve(new _document.TextNode(data.text, data.formats));\n});\n\n_parser.parser.on('pom', 'image', function (token, data) {\n    return Promise.resolve(new _document.Image(data.src, data.title, data.alt));\n});\n\n_parser.parser.on('pom', 'Fields', function (token, data) {\n    var fields = {};\n    return Promise.all(Object.keys(data).filter(function (key) {\n        return key !== 'type';\n    }).map(function (key) {\n        return fromPOM(data[key]).then(function (POM) {\n            fields[key] = POM;\n        });\n    })).then(function () {\n        return Promise.resolve(new _document.Fields(fields));\n    });\n});\n\n_parser.parser.on('pom', 'Variants', function (token, data) {\n    var variants = {};\n    return Promise.all(Object.keys(data).filter(function (key) {\n        return key !== 'type';\n    }).map(function (key) {\n        return fromPOM(data[key]).then(function (POM) {\n            variants[key] = POM;\n        });\n    })).then(function () {\n        return Promise.resolve(new _document.Variants(variants));\n    });\n});\n\n},{\"./../document\":2,\"./../parser\":7}],10:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.repository = exports.DEFAULT_DOCUMENT = exports.CHANGE = undefined;\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nvar _emitter = require('./emitter');\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; } /* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nvar CHANGE = exports.CHANGE = 'change';\nvar DEFAULT_DOCUMENT = exports.DEFAULT_DOCUMENT = '#default';\n\nvar Repository = function (_Emitter) {\n    _inherits(Repository, _Emitter);\n\n    function Repository() {\n        _classCallCheck(this, Repository);\n\n        var _this = _possibleConstructorReturn(this, Object.getPrototypeOf(Repository).call(this));\n\n        _this._documents = {};\n        return _this;\n    }\n\n    _createClass(Repository, [{\n        key: 'get',\n        value: function get(documentId) {\n            if (this._documents[documentId]) {\n                return this._documents[documentId].content;\n            }\n        }\n    }, {\n        key: 'set',\n        value: function set(documentId, value) {\n            this._documents[documentId] = {\n                content: value\n            };\n            this.emit(CHANGE, {\n                id: documentId\n            });\n        }\n    }, {\n        key: 'has',\n        value: function has(documentId) {\n            return !!this._documents[documentId];\n        }\n    }, {\n        key: 'toJSON',\n        value: function toJSON() {\n            var _this2 = this;\n\n            var data = {};\n            Object.keys(this._documents).forEach(function (key) {\n                //console.log(this._documents[key].content);\n                data[key] = {\n                    id: key,\n                    content: _this2._documents[key].content.toJSON()\n                };\n            });\n            return data;\n        }\n    }, {\n        key: 'main',\n        get: function get() {\n            return this._documents[DEFAULT_DOCUMENT];\n        }\n    }]);\n\n    return Repository;\n}(_emitter.Emitter);\n\nvar repository = exports.repository = new Repository();\n\n},{\"./emitter\":4}],11:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nvar Serializer = function () {\n    function Serializer() {\n        _classCallCheck(this, Serializer);\n    }\n\n    _createClass(Serializer, [{\n        key: 'serialize',\n        value: function serialize(format, node, options) {\n\n            if (!node) {\n                return Promise.reject(new Error('Model is empty'));\n            }\n\n            if (!node.type) {\n                return Promise.reject(new Error('Undefined node type'));\n            }\n\n            return this.handle(format, node.type, node, options);\n        }\n    }, {\n        key: 'on',\n        value: function on(format, nodeType, handler) {\n            this._handlers = this._handlers || {};\n            this._handlers[format] = this._handlers[format] || {};\n            this._handlers[format][nodeType] = handler;\n        }\n    }, {\n        key: 'handle',\n        value: function handle(format, nodeType, node, options) {\n\n            var handler = this._handlers && this._handlers[format] && this._handlers[format][nodeType] ? this._handlers[format][nodeType] : null;\n            if (!handler) {\n                handler = this._handlers && this._handlers[format] && this._handlers[format]['*'] ? this._handlers[format]['*'] : null;\n                if (!handler) {\n                    return Promise.reject(new Error('No handler defined for ' + format + ' : ' + nodeType));\n                }\n            }\n            return handler(node, options).then(function (html) {\n                return html;\n            });\n        }\n    }, {\n        key: 'handleContents',\n        value: function handleContents(format, array, options) {\n            var self = this;\n            return Promise.all(array.map(function (content) {\n                return self.serialize('html', content, options);\n            }));\n        }\n    }]);\n\n    return Serializer;\n}();\n\nvar serializer = exports.serializer = new Serializer();\n\n},{}],12:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }(); /* jslint esnext:true, node:true */\n/* globals document */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nexports.toHTML = toHTML;\nexports.element = element;\n\nvar _serializer = require('./../serializer');\n\nvar _document = require('./../document');\n\nvar _util = require('./../util');\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction toHTML(model, options) {\n    return _serializer.serializer.serialize('html', model, options);\n}\n\nfunction otherAttrs(object, except) {\n    var result = {};\n    Object.keys(object).filter(function (key) {\n        return except.indexOf(key) === -1;\n    }).forEach(function (key) {\n        result[key] = object[key];\n    });\n    return result;\n}\n\nfunction format(string, formats) {\n    var wrapper = document.createElement('p'),\n        slices = string.split('').map(function (char) {\n        return {\n            char: char,\n            apply: []\n        };\n    });\n\n    slices.push({\n        char: '',\n        apply: []\n    });\n\n    console.log(string);\n\n    formats.forEach(function (format) {\n        var from = format.slice[0],\n            to = from + format.slice[1];\n\n        console.log(from, to, slices.length);\n\n        format.apply.forEach(function (apply) {\n            if (slices[from].apply.indexOf(apply) == -1) {\n                slices[from].apply.push(apply);\n            }\n            if (slices[to].apply.indexOf('/' + apply) == -1) {\n                slices[to].apply.push('/' + apply);\n            }\n        });\n    });\n    wrapper.innerHTML = slices.map(function (char) {\n        return char.apply.map(function (tag) {\n            return '<' + tag + '>';\n        }).join('') + char.char;\n    }).join('');\n    return (0, _util.arraize)(wrapper.childNodes);\n}\n\nfunction element(node, nodeType, attributes, content, options) {\n\n    var promise = void 0;\n\n    if (content) {\n\n        promise = _serializer.serializer.handleContents('html', content || [], options);\n    } else {\n        promise = Promise.resolve(null);\n    }\n\n    return promise.then(function (content) {\n\n        if (node.formats && node.formats.length) {\n            content = format(content[0].nodeValue, node.formats);\n        }\n\n        var elem = document.createElement(nodeType);\n        if (options && options.edit) {\n            elem.setAttribute('data-skaryna-id', node.name);\n        }\n        if (attributes) {\n            Object.keys(attributes).forEach(function (attributeName) {\n                elem.setAttribute(attributeName, attributes[attributeName]);\n            });\n        }\n        if (Array.isArray(content)) {\n            content.forEach(function (child) {\n                return elem.appendChild(child);\n            });\n        }\n        return elem;\n    });\n}\n\nvar FakeDoc = function () {\n    function FakeDoc() {\n        _classCallCheck(this, FakeDoc);\n\n        this.children = [];\n    }\n\n    _createClass(FakeDoc, [{\n        key: 'appendChild',\n        value: function appendChild(child) {\n            this.children.push(child);\n        }\n    }, {\n        key: 'outerHTML',\n        get: function get() {\n            var str = '';\n            this.children.forEach(function (child) {\n                if (child.nodeType === 1) {\n                    str += child.outerHTML;\n                } else {\n                    str += child.textContent;\n                }\n            });\n            return str;\n        }\n    }]);\n\n    return FakeDoc;\n}();\n\n_serializer.serializer.on('html', 'document', function (node, options) {\n    return _serializer.serializer.handleContents('html', node.items || [], options).then(function (contents) {\n        var output = new FakeDoc();\n        if (Array.isArray(contents)) {\n            contents.forEach(function (child) {\n                return output.appendChild(child);\n            });\n        }\n        return output;\n    });\n});\n\n_serializer.serializer.on('html', 'heading', function (node, options) {\n    return element(node, 'h' + (node.level || 1), node.attr(), [new _document.TextNode(node.text, node.formats)], options);\n});\n\n_serializer.serializer.on('html', 'paragraph', function (node, options) {\n    return element(node, 'p', node.attr(), [new _document.TextNode(node.text, node.formats)], options);\n});\n\n_serializer.serializer.on('html', 'image', function (node, options) {\n    return element(node, 'img', node.attr(), null, options);\n});\n\n_serializer.serializer.on('html', 'text', function (node, options) {\n    var element = document.createTextNode(node.text);\n    if (options && options.edit) {\n        //element.setAttribute('name', node.name);\n    }\n    return Promise.resolve(element);\n});\n\n_serializer.serializer.on('html', '*', function (node, options) {\n    return element(node, node._type, node.attr(), node.items, options);\n});\n\n},{\"./../document\":2,\"./../serializer\":11,\"./../util\":14}],13:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nvar Toolbar = exports.Toolbar = function () {\n    function Toolbar() {\n        _classCallCheck(this, Toolbar);\n\n        //super();\n\n        this.element = document.createElement('div');\n        this.element.setAttribute('data-skaryna-toolbar', '');\n        this.element.innerHTML = '<div data-skaryna-toolbar-actions>aaaaaaaaa</div><div data-skaryna-toolbar-arrow><span></span></div>';\n        this.arrow = this.element.querySelector('[data-skaryna-toolbar-arrow]');\n\n        var styles = document.createElement('style');\n        styles.innerText = '\\n            [data-skaryna-toolbar] {\\n                position: absolute;\\n                visibility: hidden;\\n                display: none;\\n                z-index: 10000;\\n                transition: none;\\n                top: 0;\\n                left: 0;\\n            }\\n\\n            [data-skaryna-toolbar-actions] {\\n                position: relative;\\n                background-image: linear-gradient(to bottom,rgba(49,49,47,.99),#262625);\\n                background-repeat: repeat-x;\\n                border-radius: 5px;\\n            }\\n\\n            [data-skaryna-toolbar-arrow] {\\n                position: absolute;\\n                bottom: -10px;\\n                left: 50%;\\n                clip: rect(10px 20px 20px 0);\\n                margin-left: -10px;\\n            }\\n\\n            [data-skaryna-toolbar-arrow] > span {\\n                display: block;\\n                width: 20px;\\n                height: 20px;\\n                background-color: #262625;\\n                transform: rotate(45deg) scale(.5);\\n            }\\n            ';\n\n        document.body.appendChild(styles);\n        document.body.appendChild(this.element);\n    }\n\n    _createClass(Toolbar, [{\n        key: 'getSelectionCoords',\n        value: function getSelectionCoords(theWindow) {\n            var win = theWindow || window,\n                doc = win.document,\n                sel = doc.selection,\n                range = void 0,\n                rects = void 0,\n                rect = void 0,\n                x = 0,\n                y = 0;\n            if (sel) {\n                if (sel.type != \"Control\") {\n                    range = sel.createRange();\n                    range.collapse(true);\n                    x = range.boundingLeft;\n                    y = range.boundingTop;\n                }\n            } else if (win.getSelection) {\n                sel = win.getSelection();\n                if (sel.rangeCount) {\n                    range = sel.getRangeAt(0).cloneRange();\n                    if (range.getClientRects) {\n                        range.collapse(true);\n                        rects = range.getClientRects();\n\n                        if (rects.length > 0) {\n                            rect = rects[0];\n                        }\n                        x = rect.left;\n                        y = rect.top;\n                    }\n                    // Fall back to inserting a temporary element\n                    if (x == 0 && y == 0) {\n                        var span = doc.createElement(\"span\");\n                        if (span.getClientRects) {\n                            // Ensure span has dimensions and position by\n                            // adding a zero-width space character\n                            span.appendChild(doc.createTextNode('​'));\n                            range.insertNode(span);\n                            rect = span.getClientRects()[0];\n                            x = rect.left;\n                            y = rect.top;\n                            var spanParent = span.parentNode;\n                            spanParent.removeChild(span);\n\n                            // Glue any broken text nodes back together\n                            spanParent.normalize();\n                        }\n                    }\n                }\n            }\n            return {\n                x: x,\n                y: y\n            };\n        }\n    }, {\n        key: 'anchor',\n        value: function anchor() {\n            var _this = this;\n\n            var coords = this.getSelectionCoords(),\n                self = this,\n                rect = void 0,\n                arrow = void 0;\n            this.element.style.display = 'block';\n            this.element.style.visibility = 'visible';\n\n            setTimeout(function () {\n                rect = _this.element.getBoundingClientRect();\n                arrow = _this.arrow.getBoundingClientRect();\n                console.log(rect, coords, arrow);\n                _this.show(coords.x, coords.y - rect.height - 10);\n            }, 1);\n        }\n    }, {\n        key: 'show',\n        value: function show(x, y) {\n            this.element.style.top = y + 'px';\n            this.element.style.left = x + 'px';\n        }\n    }, {\n        key: 'hide',\n        value: function hide() {\n            this.element.style.display = null;\n            this.element.style.visibility = null;\n        }\n    }]);\n\n    return Toolbar;\n}();\n\n},{}],14:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol ? \"symbol\" : typeof obj; };\n\nexports.arraize = arraize;\nexports.clone = clone;\n/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\n/**\n * Convert iterable objects into arrays\n * @param   {Iterable} iterable\n * @returns {Array}\n */\nfunction arraize(iterable) {\n    return [].slice.apply(iterable);\n}\n\nfunction clone(inputs, except) {\n    var result = {};\n    inputs.forEach(function (input) {\n        if ((typeof input === 'undefined' ? 'undefined' : _typeof(input)) !== 'object') {\n            return;\n        }\n        Object.keys(input).forEach(function (key) {\n            if (except && except.indexOf(key) !== -1) {\n                return;\n            }\n            result[key] = JSON.parse(JSON.stringify(input[key]));\n        });\n    });\n    return result;\n}\n\n},{}],15:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n/* jslint esnext:true, node:true, browser:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nvar XHR = exports.XHR = function () {\n  function XHR() {\n    _classCallCheck(this, XHR);\n  }\n\n  _createClass(XHR, null, [{\n    key: 'ajax',\n    value: function ajax(path, method, data, raw) {\n\n      return new Promise(function (resolve, reject) {\n\n        var xhr = new XMLHttpRequest(),\n            httpMethod = method.toLowerCase();\n\n        xhr.open(httpMethod, path);\n        if (httpMethod === 'post' || httpMethod === 'put') {\n          xhr.setRequestHeader('Content-type', 'application/json');\n        }\n\n        xhr.onreadystatechange = function () {\n          var DONE = 4,\n              // readyState 4 means the request is done.\n          OK = 200; // status 200 is a successful return.\n          if (xhr.readyState === DONE) {\n            if (xhr.status === OK) {\n              resolve(xhr.responseText); // 'This is the returned text.'\n            } else if (xhr.status === '204') {\n                resolve(null);\n              } else {\n                reject(new Error('Error: ' + xhr.status)); // An error occurred during the request.\n              }\n          }\n        };\n\n        xhr.send(data ? raw ? data : JSON.stringify(data) : null);\n      });\n    }\n  }, {\n    key: 'get',\n    value: function get(path, raw) {\n      return XHR.ajax(path, 'get', null, raw);\n    }\n  }, {\n    key: 'post',\n    value: function post(path, data, raw) {\n      return XHR.ajax(path, 'post', data, raw);\n    }\n  }, {\n    key: 'put',\n    value: function put(path, data, raw) {\n      return XHR.ajax(path, 'put', data, raw);\n    }\n  }, {\n    key: 'delete',\n    value: function _delete(path, raw) {\n      return XHR.ajax(path, 'delete', null, raw);\n    }\n  }]);\n\n  return XHR;\n}();\n\n},{}]},{},[1])\n\n","/* jslint esnext:true, node:true, browser:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nimport {\n    Skaryna\n}\nfrom './index';\nimport {\n    Editor\n}\nfrom './editor';\nimport {\n    repository\n}\nfrom './repository';\nimport {\n    XHR\n}\nfrom './xhr';\n\nSkaryna.Editor = Editor;\nSkaryna.repository = repository;\nSkaryna.XHR = XHR;\n\nwindow.Skaryna = Skaryna;\n\nif (Array.isArray(window.___Skaryna)) {\n    window.___Skaryna.forEach((callback) => {\n        callback.apply(window);\n    });\n}\n","/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nimport {\n    Emitter\n}\nfrom './emitter';\nimport {\n    clone,\n    arraize\n}\nfrom './util';\nimport {\n    toHTML\n}\nfrom './serializer/toHTML';\n\nlet elementMap = {};\n\n\n/**\n * @see https://github.com/component/escape-regexp\n * @param   {string} str\n * @returns {string}\n */\nexport function escapeRegexp(str) {\n    return String(str).replace(/([.*+?=^!:${}()|[\\]\\/\\\\])/g, '\\\\$1');\n}\n\n/**\n * @see https://github.com/sielay/bestmatch\n * @param   {array} list\n * @param   {string}   filter\n * @returns {string}\n */\nexport function bestMatch(list, filter) {\n    var lowest = null,\n        best;\n\n    list.forEach(function (rule) {\n        var regexp = new RegExp(escapeRegexp(rule).replace(/\\\\\\*/g, '(.+)')),\n            weight = rule.split('*').filter(function (part) {\n                return part.length;\n            }).length,\n            match = filter.match(regexp);\n\n        if (match && (lowest === null || (match.length - weight) < lowest)) {\n            lowest = match.length - weight;\n            best = rule;\n        }\n    });\n    return best;\n}\n\nexport function getById(id) {\n    return elementMap[id];\n}\n\nexport function getByNode(element) {\n    if(!element) {\n        return null;\n    }\n    let id = element.getAttribute('data-skaryna-id');\n    return getById(id);\n}\n\nexport function randomID(setValue) {\n    var possible = 'abcdefghijklmnopqrstuvwxyz0123456789',\n        text = '';\n\n    for (let i = 0; i < 5; i++) {\n        text += possible.charAt(Math.floor(Math.random() * possible.length));\n    }\n\n    if (Object.keys(elementMap).indexOf(text) === -1) {\n        elementMap[text] = elementMap[text] || setValue;\n        return text;\n    }\n    return randomID(setValue);\n}\n\n/**\n * @class\n */\nexport class Node extends Emitter {\n\n    /**\n     * @constructs Node\n     */\n    constructor() {\n        super();\n\n        this.name = randomID(this);\n\n        this.__locked = false;\n    }\n\n    get locked() {\n        return this.__locked;\n    }\n\n    lock() {\n        this.__locked = true;\n    }\n\n    attr() {\n        return this.attrs;\n    }\n\n    get() {\n        throw new Error('Should be implemented');\n    }\n\n    /**\n     * @abstract\n     * @throws {Error}\n     */\n    toJSON() {\n        let error = new Error('Should be implemented');\n        throw error;\n    }\n\n    get defaultNewItem() {\n        return null;\n    }\n\n    get allowedNewItems() {\n        return [];\n    }\n}\n\n/**\n * @class\n * Defined for Image, Video, Embed, Table, HorizonalRule, Table, List or Component\n */\nexport class BlockNode extends Node {\n\n    constructor(type, items, attrs) {\n        super();\n        this._type = type;\n        this.items = items || [];\n        this.attrs = attrs;\n    }\n\n    get(path) {\n        let elements = path.split('.'),\n            index = elements.shift(),\n            rest = elements.join('.'),\n            child;\n\n        if (isNaN(index)) {\n            return null;\n        }\n\n        child = this.items[+index];\n\n        if (rest.length && child) {\n            return child.get(rest);\n        }\n\n        return child;\n\n    }\n\n    get empty() {\n        return this.items.length <= 0;\n    }\n\n    get type() {\n        return this._type;\n    }\n\n    toJSON() {\n        let output = {\n            type: this.type,\n            items: this.items.map((item) => item.toJSON())\n        };\n        if (this.attrs) {\n            output.attrs = JSON.parse(JSON.stringify(this.attrs));\n        }\n        return output;\n    }\n\n    decorate(element) {\n        return toHTML(this, {\n                edit: true\n            })\n            .then((html) => {\n                element.innerHTML = '';\n                arraize(html.children)\n                    .forEach((child) => {\n                        element.appendChild(child);\n                    });\n            });\n    }\n}\n\nexport class Document extends BlockNode {\n\n    constructor(items) {\n        super('document', items);\n    }\n\n    get defaultNewItem() {\n        return Paragraph;\n    }\n\n    get allowedNewItems() {\n        return [\n            Paragraph,\n            Image\n        ];\n    }\n\n}\n\nexport class Quote extends BlockNode {\n    constructor(items) {\n        super('quote', items);\n    }\n}\n\n/**\n * @class\n * Defined for Text, Paragraph, ListItem, Quote and Heading\n */\nexport class TextNode extends Node {\n\n    get type() {\n        return 'text';\n    }\n\n    static get type() {\n        return 'text';\n    }\n\n    get empty() {\n        return !this.text || !this.text.replace(/^([\\s\\n\\r\\t]+)|([\\s\\n\\r\\t]+)$/, '').length;\n    }\n\n    get absoluteEmpty() {\n        return this.text.length === 0;\n    }\n\n    attr() {\n        if (this.type === 'text') {\n            return {};\n        }\n        return super.attr();\n    }\n\n    constructor(text, formats, attrs) {\n        super();\n        this.text = (text && text.toString) ? text.toString() : '';\n        this.formats = formats || null;\n        this.attrs = attrs;\n    }\n\n    toJSON() {\n        let output = {\n            type: this.type,\n            text: this.text\n        };\n        if (this.formats) {\n            output.formats = JSON.parse(JSON.stringify(this.formats));\n        }\n        if (this.attrs && this.type !== 'text') {\n            output.attrs = JSON.parse(JSON.stringify(this.attrs));\n        }\n        return output;\n    }\n\n    append(node) {\n        if (!(node instanceof TextNode)) {\n            throw new Error('Only text nodes can be joined');\n        }\n        if (node.formats) {\n            this.formats = this.formats || [];\n            node.formats.forEach((format) => {\n                this.formats.push({\n                    slice: [format.slice[0] + this.text.length, format.slice[1]],\n                    apply: format.apply\n                });\n            });\n        }\n        this.text += node.text;\n    }\n\n    decorate(element) {\n        return toHTML(this, {\n                edit: true\n            })\n            .then((html) => {\n                element.innerHTML = html.textContent;\n            });\n    }\n}\n\nexport class Paragraph extends TextNode {\n\n    get type() {\n        return 'paragraph';\n    }\n\n    static get type() {\n        return 'paragraph';\n    }\n\n    constructor(text, formats, attrs) {\n        super(text, formats, attrs);\n    }\n\n    get nextNodeType() {\n        return Paragraph;\n    }\n}\n\nexport class Image extends Node {\n\n    constructor(source, title, alt) {\n        super('image');\n        this.src = source;\n        this.title = title;\n        this.alt = alt;\n    }\n\n    get type() {\n        return 'image';\n    }\n\n    static get type() {\n        return 'image';\n    }\n\n    attr() {\n        let attributes = super.attr() || {};\n        if (this.src) {\n            attributes.src = this.src;\n        }\n        if (this.title) {\n            attributes.title = this.title;\n        }\n        if (this.alt) {\n            attributes.alt = this.title;\n        }\n        return attributes;\n    }\n\n    toJSON() {\n        let output = {\n            type: 'image',\n            src: this.src\n        };\n        if (this.title) {\n            output.title = this.title;\n        }\n        if (this.alt) {\n            output.alt = this.alt;\n        }\n        return output;\n    }\n}\n\nexport class Heading extends TextNode {\n\n    constructor(level, text, formats, attrs) {\n        super(text, formats, attrs);\n        this.level = Math.min(6, level || 0);\n    }\n\n    attr() {\n        return super.attr();\n    }\n    get type() {\n        return 'heading';\n    }\n\n    static get type() {\n        return 'heading';\n    }\n\n    toJSON() {\n        let json = super.toJSON();\n        json.level = this.level;\n        return json;\n    }\n}\n\nexport class StaticBlockNode extends BlockNode {\n    get locked() {\n        return true;\n    }\n\n    get defaultNewItem() {\n        return Paragraph;\n    }\n\n    get allowedNewItems() {\n        return [\n            Paragraph,\n            Image\n        ];\n    }\n}\n\nexport class Fields extends Node {\n\n    constructor(data) {\n        super();\n        this._map = data;\n    }\n\n    get type() {\n        return 'Fields';\n    }\n\n    static get type() {\n        return 'Fields';\n    }\n\n    get(path) {\n        let elements = path.split('.'),\n            index = elements.shift(),\n            rest = elements.join('.'),\n            child;\n\n        child = this._map[index];\n\n        if (rest.length && child) {\n            return child.get(rest);\n        }\n\n        return child;\n\n    }\n\n    toJSON() {\n        return clone([\n            this._map,\n            {\n                type: 'Fields'\n            }\n        ]);\n    }\n}\n\nexport class Variants extends Node {\n\n    constructor(data) {\n        super();\n        this._variants = data;\n    }\n\n    get type() {\n        return 'Variants';\n    }\n\n    static get type() {\n        return 'Variants';\n    }\n\n\n    best(variant) {\n        let best = bestMatch(Object.keys(this._variants), variant);\n        return this._variants[best];\n\n    }\n\n    toJSON() {\n        return clone([\n            this._map,\n            {\n                type: 'Variants'\n            }\n        ]);\n    }\n}\n","/* jslint esnext:true, node:true, browser:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nimport {\n    Event, Emitter\n}\nfrom './emitter';\n\nimport {\n    arraize\n}\nfrom './util';\nimport {\n    repository, CHANGE, DEFAULT_DOCUMENT\n}\nfrom './repository';\nimport {\n    toHTML\n}\nfrom './serializer/toHTML';\nimport {\n    fromHTML\n}\nfrom './parser/fromHTML';\nimport {\n    fromPOM\n}\nfrom './parser/fromPOM';\nimport {\n    XHR\n}\nfrom './xhr';\nimport {\n    Variants,\n    randomID,\n    getById,\n    getByNode\n}\nfrom './document';\n\nconst BACKSPACE = 8,\n    TAB = 9,\n    ENTER = 13,\n    SHIFT = 16,\n    CAPS = 20,\n    ESC = 27,\n    SPACE = 32,\n    UP = 38,\n    DOWN = 40,\n    DELETE = 46,\n    PREVENT = [ENTER];\n\nimport {\n    Toolbar\n}\nfrom './toolbar';\nimport {\n    Injector\n}\nfrom './injector';\n\nlet toolbar = new Toolbar(),\n    injector;\n\n/**\n * @class\n */\nexport class Editor extends Emitter {\n\n    /**\n     * [[Description]]\n     * @param {HTMLElement} element\n     * @returns {Promise} [[Description]]\n     */\n    static factory(element) {\n        let editor = new Editor(element);\n        return editor.inited;\n    }\n\n    /**\n     * [[Description]]\n     * @param {HTMLElement} element\n     * @returns {Promise} [[Description]]\n     */\n    static initEditors(element) {\n        return Promise.all(arraize(element.querySelectorAll('[data-skaryna]'))\n            .map((element) => Editor.factory(element)));\n    }\n\n    /**\n     * [[Description]]\n     * @param {Object} documentBody [[Description]]\n     * @param {[[Type]]} documentId   [[Description]]\n     */\n    static registerDocument(documentBody, documentId) {\n        repository.set(documentId || DEFAULT_DOCUMENT, documentBody);\n    }\n\n    /**\n     * Loads data from REST endpoint\n     * @param   {string} path\n     * @param   {string} documentId\n     * @returns {Promise}\n     */\n    static load(path, documentId) {\n        return XHR\n            .get(path)\n            .then((content) => {\n                return fromPOM(JSON.parse(content));\n            })\n            .then((content) => {\n                repository.set(documentId || DEFAULT_DOCUMENT, content);\n            });\n    }\n\n    /**\n     * @param {HTMLElement} element\n     */\n    constructor(element) {\n        super();\n\n        this.element = element;\n        this.documentPath = element.getAttribute('data-skaryna-path') || null;\n        this.document = element.getAttribute('data-skaryna-doc') || DEFAULT_DOCUMENT;\n        this.variant = element.getAttribute('data-skaryna-variant') || null;\n\n        this._pendingState = null;\n        this._rendering = false;\n\n        this.init();\n\n    }\n\n    /**\n     * Inits component\n     * @returns {Promise}\n     */\n    init() {\n        let self = this;\n        if (this.inited) {\n            return this.inited;\n        }\n        this.inited = fromHTML(this.element, {\n                edit: true\n            })\n            .then((content) => {\n                content.lock();\n                if (repository.has(self.document)) {\n                    let doc = repository.get(self.document);\n                    if (self.documentPath) {\n                        doc = doc.get(self.documentPath);\n                        if (doc && doc.type === 'Variants' && doc.best) {\n                            doc = doc.best(self.variant || '*');\n                        }\n                    }\n                    self.content = doc;\n                } else if (!content.empty) {\n                    repository.set(self.document, content);\n                    self.content = content;\n                }\n            })\n            .then(() => {\n                self.render();\n            })\n            .catch((error) => {\n                console.log(error);\n                console.log(error.stack);\n            });\n    }\n\n    getCaretCharacterOffsetWithin(element) {\n        let caretOffset = 0,\n            doc = element.ownerDocument || element.document,\n            win = doc.defaultView || doc.parentWindow,\n            sel;\n        if (typeof win.getSelection != 'undefined') {\n            sel = win.getSelection();\n            if (sel.rangeCount > 0) {\n                let range = win.getSelection().getRangeAt(0),\n                    preCaretRange = range.cloneRange();\n                preCaretRange.selectNodeContents(element);\n                preCaretRange.setEnd(range.endContainer, range.endOffset);\n                caretOffset = preCaretRange.toString().length;\n            }\n        } else if ((sel = doc.selection) && sel.type != 'Control') {\n            let textRange = sel.createRange(),\n                preCaretTextRange = doc.body.createTextRange();\n            preCaretTextRange.moveToElementText(element);\n            preCaretTextRange.setEndPoint('EndToEnd', textRange);\n            caretOffset = preCaretTextRange.text.length;\n        }\n        return caretOffset;\n    }\n\n    getSelectionLength(element) {\n\n    }\n\n    getCurrentElement(element) {\n\n        let doc = element.ownerDocument || element.document,\n            win = doc.defaultView || doc.parentWindow,\n            sel,\n            node;\n\n        if (typeof win.getSelection != 'undefined') {\n            sel = win.getSelection();\n        } else {\n            sel = doc.selection;\n        }\n\n        node = sel.focusNode;\n\n        if (node === this.element) {\n            return this.element;\n        }\n        return this.getEditableNode(node);\n    }\n\n    getEditableNode(node) {\n        while (node && (!node.hasAttribute || !node.hasAttribute('data-skaryna-id'))) {\n            node = node.parentNode;\n        }\n        return node;\n    }\n\n    onDOM(selectorORElement, eventName, myMethod) {\n        let self = this;\n        if (selectorORElement instanceof HTMLElement) {\n            selectorORElement = [selectorORElement];\n        } else {\n            selectorORElement = arraize(this.element.querySelectorAll(selectorORElement));\n        }\n        selectorORElement\n            .forEach(element => {\n                element.addEventListener(eventName, event => {\n                    myMethod.apply(self, [event]);\n                }, true);\n            });\n    }\n\n    /**\n     * Renders UI\n     * @returns {Promise}\n     */\n    render() {\n        this._rendering = true;\n        let self = this,\n            promise;\n\n        if (!this.content) {\n            this._rendering = false;\n            promise = Promise.resolve();\n        } else {\n            promise = this.content\n                .decorate(this.element)\n                .then(() => {\n                    this._rendering = false;\n                });\n        }\n\n        return promise\n            .then(() => {\n                self.element.setAttribute('data-skaryna-id', self.content ? self.content.name : randomID(true));\n                self.element.setAttribute('contentEditable', '');\n                self.element.addEventListener('keydown', (event) => {\n                    self.onKeyUp(event);\n                }, true);\n                self.onDOM('[data-skaryna-id]', 'mouseup', self.focus);\n                self.onDOM(self.element, 'mouseup', self.focus);\n                /*\n                    self.element.addEventListener('mouseup', (event) => {\n                        let sel = window.getSelection ? window.getSelection().toString() : document.selection.createRange().text;\n                        if (sel && sel.length) {\n                            self.onSelect(event);\n                        }\n                    }, true);*/\n            });\n    }\n\n    onSelect(event) {\n\n        /*this.showToolbar();\n        this.strong();*/\n    }\n\n    showToolbar() {\n        toolbar.anchor();\n    }\n\n    focus(event) {\n        let node = this.getEditableNode(event.target),\n            focusedNode = getByNode(node),\n            parentNode = getByNode(node.parentNode),\n            newItems,\n            injectorObject;\n\n        newItems = parentNode ? parentNode.allowedNewItems : focusedNode.allowedNewItems;\n\n        this.hideInjector();\n\n        if (newItems.length > 0) {\n            if (!parentNode) {\n                injectorObject = this.showInjector(node.parentNode.lastChild, newItems);\n            } else {\n                injectorObject = this.showInjector(node, newItems);\n            }\n            injectorObject.on('injectnode', event => {\n                if (parentNode) {\n                    let index = parentNode.items.indexOf(focusedNode);\n                    parentNode.items.splice(index, 0, new event.data());\n                } else {\n                    parentNode.items.push(new event.data());\n                }\n                this.render();\n            });\n        }\n    }\n\n    showInjector(afterNode, possibleItems) {\n        let injectorObject = new Injector(possibleItems),\n            box = afterNode.getBoundingClientRect(),\n            injectorBox;\n\n        injector = injectorObject.element;\n        document.body.appendChild(injector);\n        setTimeout(() => {\n            injectorBox = injector.getBoundingClientRect();\n            injector.style.top = (box.top) + 'px';\n            injector.style.left = (box.left - injectorBox.width) + 'px';\n        }, 0);\n        return injectorObject;\n\n    }\n\n    hideInjector() {\n        if (injector) {\n            if (injector.parentNode) {\n                injector.parentNode.removeChild(injector);\n            }\n            injector = null;\n        }\n    }\n\n    strong() {\n        let textNode = this.getCurrentElement(event.target),\n            sel = window.getSelection ? window.getSelection().toString() : document.selection.createRange().text,\n            to = sel.length,\n            from = this.getCaretCharacterOffsetWithin(textNode) - to;\n\n\n        fromHTML(textNode)\n            .then((POM) => {\n                POM.formats = POM.formats || [];\n                POM.formats.push({\n                    slice: [from, to],\n                    apply: ['strong']\n                });\n                return toHTML(POM);\n            })\n            .then((HTML) => {\n                textNode.innerHTML = HTML.innerHTML;\n            });\n    }\n\n    /**\n     * Handles external change\n     * @param {object} event\n     */\n    onExternalChange(event) {\n        if (this._rendering) {\n            this._pendingState = true;\n            return;\n        }\n        this.render();\n    }\n\n    newItem(target) {\n        let currentTarget = target,\n            node = getByNode(currentTarget),\n            self = this;\n        while (node !== null) {\n            if (!node) {\n                return;\n            }\n            if (node.defaultNewItem) {\n                let newElement = new(node.defaultNewItem)();\n                node.items.push(newElement);\n\n                toHTML(newElement, {\n                        edit: true\n                    })\n                    .then(htmlElement => {\n                        currentTarget.appendChild(htmlElement);\n                        self.editNode(htmlElement);\n                    });\n                return;\n            }\n            currentTarget = currentTarget.parentNode;\n            node = getByNode(currentTarget);\n        }\n    }\n\n    editNode(node) {\n        let range = document.createRange(),\n            sel = window.getSelection();\n        range.setStart(node, 0);\n        range.collapse(true);\n        sel.removeAllRanges();\n        sel.addRange(range);\n    }\n\n    ownAction(key, target) {\n        if (key === ENTER) {\n            return this.newItem(target);\n        }\n    }\n\n    /**\n     * Handles key up event\n     * @param {Event} event\n     */\n    onKeyUp(event) {\n\n        if (PREVENT.indexOf(event.keyCode) !== -1) {\n            event.stopPropagation();\n            event.preventDefault();\n            this.ownAction(event.keyCode, this.getCurrentElement(event.target));\n        }\n\n    }\n}\n\nlet styles = document.createElement('style');\nstyles.innerText = `\n        p[data-skaryna-id]:empty {\n                display: block;\n                height: 1em;\n            }\n        }\n        `;\n\ndocument.body.appendChild(styles);\n","/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\n/**\n * @namespace skaryna\n *\n * @class EventConfig\n * @property {function} fn listener\n * @property {object} context\n * @property {array} args arguments to be passed\n * @property {boolean} once if should be fired only once\n */\n\n/**\n * @class Event\n */\nexport class Event {\n    /**\n     * Contructor\n     * @constructs Event\n     * @param {string} name\n     * @param {mixed} data\n     * @param {object} source\n     * @param {Event} parent\n     */\n    constructor(name, data, source, parent) {\n        Object.defineProperties(this, {\n            /**\n             * @property {string}\n             * @name Event#name\n             */\n            name: {\n                value: name,\n                writable: false\n            },\n            /**\n             * @property {mixed}\n             * @name Event#data\n             */\n            data: {\n                value: data,\n                writable: false\n            },\n            /**\n             * @property {object}\n             * @name Event#source\n             */\n            source: {\n                value: source,\n                writable: false\n            },\n            /**\n             * @property {Event|null}\n             * @name Event#parent\n             */\n            parent: {\n                value: parent,\n                writable: false\n            }\n        });\n    }\n\n    toJSON() {\n        return {\n            name: this.name,\n            data: this.data,\n            source: this.source,\n            parent: this.parent\n        };\n    }\n\n    toString() {\n        return 'Event: ' + JSON.stringify(this.toJSON());\n    }\n}\n\n/**\n * [[Description]]\n * @param {Event} cofnig\n * @param {EventConfig} thisObject\n */\nfunction execute(event, config) {\n    let {\n        fn, context, args\n    } = config,\n    params = [event].concat(args);\n\n    fn.apply(context || null, params);\n}\n\n/*\n * @class Emitter\n */\nexport class Emitter {\n\n    /**\n     * Adds listener for an event\n     * @param {string} eventName\n     * @param {function} handler\n     * @param {object} context\n     * @param {array} args\n     * @param {boolean} once\n     */\n    on(eventName, handler, context, args, once) {\n        this.__listeners = this.__listeners || {};\n        this.__listeners[eventName] = this.__listeners[eventName] || [];\n        this.__listeners[eventName].push({\n            fn: handler,\n            context: context,\n            args: args,\n            once: !!once\n        });\n    }\n\n    /**\n     * Adds listener for an event that should be called once\n     * @param {string} eventName\n     * @param {function} handler\n     * @param {object} context\n     * @param {array} args\n     */\n    once(eventName, handler, context, args) {\n        this.on(eventName, handler, context, args, true);\n    }\n\n    /**\n     * Adds listener for an event\n     * @param {string} eventName\n     * @param {function} handler\n     * @param {object} context\n     * @param {array} args\n     * @param {boolean} once\n     */\n    off(eventName, handler, context, args, once) {\n        if (!this.__listeners || !this.__listeners[eventName]) {\n            return;\n        }\n        this\n            .getListeners(eventName, handler, context, args, once)\n            .forEach((config) => {\n                this.__listeners[eventName].splice(this.__listeners[eventName].indexOf(config), 1);\n            });\n\n    }\n\n    /**\n     * Emits an event\n     * @param {string} eventName\n     * @param {mixed} data\n     * @param {Event|null} parent\n     */\n    emit(eventName, data, parent) {\n        if (!this.__listeners || !this.__listeners[eventName]) {\n            return;\n        }\n\n        let self = this,\n            event = new Event(eventName, data, this, parent);\n\n        this\n            .getListeners(eventName)\n            .forEach((config) => {\n                if (config.once === true) {\n                    self.off(eventName, config.fn, config.context, config.args, config.once);\n                }\n                execute(event, config);\n            });\n    }\n\n    /**\n     * Bubbles event to other emitter\n     * @param {string} eventName\n     * @param {object} toEmitter\n     */\n    bubbleEvent(eventName, toEmitter) {\n        this.on(eventName, (event) => {\n            toEmitter.emit(eventName, event.data, event);\n        });\n    }\n\n    /**\n     * Gets all listeners that match criteria\n     * @param   {string} eventName required\n     * @param   {function} handler   if defined will be used for match\n     * @param   {object} context   if defined will be used for match\n     * @param   {array} args      if defined will be used for match\n     * @returns {array<EventConfig>|null}\n     */\n    getListeners(eventName, handler, context, args) {\n        if (!this.__listeners || !this.__listeners[eventName]) {\n            return null;\n        }\n\n        return this.__listeners[eventName]\n            .map((config) => {\n                if (handler !== undefined && config.fn !== handler) {\n                    return false;\n                }\n                if (context !== undefined && config.context !== context) {\n                    return false;\n                }\n                if (args !== undefined && config.args !== args) {\n                    return false;\n                }\n                return config;\n            })\n            .filter((result) => !!result);\n    }\n\n}\n","/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nexport {Event, Emitter} from './emitter';\n\nexport class Skaryna {\n}\n","/* jslint esnext:true, node:true, browser:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\nimport {\n    Emitter\n}\nfrom './emitter';\n\nlet styles;\n\nconst SVGS = {\n    paragraph: 'M832 320v704q0 104-40.5 198.5t-109.5 163.5-163.5 109.5-198.5 40.5h-64q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h64q106 0 181-75t75-181v-32q0-40-28-68t-68-28h-224q-80 0-136-56t-56-136v-384q0-80 56-136t136-56h384q80 0 136 56t56 136zm896 0v704q0 104-40.5 198.5t-109.5 163.5-163.5 109.5-198.5 40.5h-64q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h64q106 0 181-75t75-181v-32q0-40-28-68t-68-28h-224q-80 0-136-56t-56-136v-384q0-80 56-136t136-56h384q80 0 136 56t56 136z',\n    image: 'M576 576q0 80-56 136t-136 56-136-56-56-136 56-136 136-56 136 56 56 136zm1024 384v448h-1408v-192l320-320 160 160 512-512zm96-704h-1600q-13 0-22.5 9.5t-9.5 22.5v1216q0 13 9.5 22.5t22.5 9.5h1600q13 0 22.5-9.5t9.5-22.5v-1216q0-13-9.5-22.5t-22.5-9.5zm160 32v1216q0 66-47 113t-113 47h-1600q-66 0-113-47t-47-113v-1216q0-66 47-113t113-47h1600q66 0 113 47t47 113z',\n    dimensions: '0 0 1792 1792'\n};\n\nexport class Injector extends Emitter {\n\n    constructor(allowedNodes) {\n        super();\n\n        let\n            self = this,\n            div = document.createElement('div');\n\n        div.innerHTML = '<div data-skaryna-tooltip=\"left\"><div></div><div></div></div>';\n\n        this.element = div.firstChild;\n\n        allowedNodes.forEach(node => {\n            let action = document.createElement('a'),\n                svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg'),\n                path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\n\n            svg.setAttribute('width', 30);\n            svg.setAttribute('height', 30);\n            svg.setAttribute('viewBox', SVGS.dimensions);\n            svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');\n            path.setAttribute('d', SVGS[node.type]);\n            path.setAttribute('fill', '#fff');\n\n            svg.appendChild(path);\n            action.appendChild(svg);\n\n            action.addEventListener('mousedown', (event) => {\n                event.preventDefault();\n                event.stopPropagation();\n                console.log(node);\n                self.emit('injectnode', node);\n\n            }, true);\n            this.element.children[1].appendChild(action);\n        });\n\n        if (!styles) {\n            styles = document.createElement('style');\n            styles.innerText = `\n        [data-skaryna-tooltip] {\n            position: absolute;\n            z-index: 1070;\n            display: block;\n            font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif;\n            font-size: 12px;\n            font-style: normal;\n            font-weight: 400;\n            line-height: 1.42857143;\n            text-align: left;\n            text-align: start;\n            text-decoration: none;\n            text-shadow: none;\n            text-transform: none;\n            letter-spacing: normal;\n            word-break: normal;\n            word-spacing: normal;\n            word-wrap: normal;\n            white-space: normal;\n            /*filter: alpha(opacity=0);\n            opacity: 0;*/\n            line-break: auto;\n            transition: opacity 0.5s;\n        }\n        [data-skaryna-tooltip] div:nth-child(2) {\n            max-width: 200px;\n            padding: 3px 8px;\n            color: #fff;\n            text-align: center;\n            background-color: #000;\n            border-radius: 4px;\n        }\n        [data-skaryna-tooltip] div:nth-child(1) {\n            position: absolute;\n            width: 0;\n            height: 0;\n            border-color: transparent;\n            border-style: solid;\n        }\n        [data-skaryna-tooltip=\"left\"] {\n            padding: 0 5px;\n            margin-left: -3px;\n        }\n        [data-skaryna-tooltip=\"top\"] {\n            padding: 5px 0;\n            margin-top: -3px;\n        }\n        [data-skaryna-tooltip=\"bottom\"] {\n            padding: 5px 0;\n            margin-top: 3px;\n        }\n        [data-skaryna-tooltip=\"right\"] {\n            padding: 0 5px;\n            margin-left: 3px;\n        }\n        [data-skaryna-tooltip=\"left\"] div:nth-child(1) {\n            top: 50%;\n            right: 0;\n            margin-top: -5px;\n            border-width: 5px 0 5px 5px;\n            border-left-color: #000;\n        }\n        [data-skaryna-tooltip=\"top\"] div:nth-child(1) {\n            bottom: 0;\n            left: 50%;\n            margin-left: -5px;\n            border-width: 5px 5px 0;\n            border-top-color: #000;\n        }\n        [data-skaryna-tooltip=\"bottom\"] div:nth-child(1) {\n            top: 0;\n            left: 50%;\n            margin-left: -5px;\n            border-width: 0 5px 5px;\n            border-bottom-color: #000;\n        }\n        [data-skaryna-tooltip=\"right\"] div:nth-child(1) {\n            top: 50%;\n            left: 0;\n            margin-top: -5px;\n            border-width: 5px 5px 5px 0;\n            border-right-color: #000;\n        }\n        [data-skaryna-tooltip] a {\n            margin-left: 10px;\n        }\n        [data-skaryna-tooltip] a:first-child{\n            margin-left: 0px;\n        }`;\n\n            document.body.appendChild(styles);\n        }\n    }\n}\n","/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nclass Parser {\n\n    parse(format, token, data, options) {\n\n        if (!token) {\n            return Promise.reject(new Error('Model is empty'));\n        }\n\n        return this.handle(format, token, data, options);\n    }\n\n    on(format, token, handler) {\n        this._handlers = this._handlers || {};\n        this._handlers[format] = this._handlers[format] || {};\n        this._handlers[format][token] = handler;\n    }\n\n    handle(format, token, data, options) {\n\n        let handler = (this._handlers && this._handlers[format] && this._handlers[format][token]) ? this._handlers[format][token] : null;\n        if (!handler) {\n            handler = (this._handlers && this._handlers[format] && this._handlers[format]['*']) ? this._handlers[format]['*'] : null;\n            if (!handler) {\n                return Promise.reject(new Error('No handler defined for ' + format + ' : ' + token));\n            }\n        }\n\n        return handler(token, data, options)\n            .then((POM) => {\n                return POM;\n            });\n    }\n\n}\n\nexport var parser = new Parser();\n","/* jslint esnext:true, node:true */\n/* globals document */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nimport {\n    parser\n}\nfrom './../parser';\nimport {\n    arraize,\n    clone\n}\nfrom './../util';\nimport {\n    Document,\n    TextNode,\n    BlockNode,\n    Paragraph,\n    Heading,\n    Image,\n    Quote,\n    StaticBlockNode\n}\nfrom './../document';\n\nfunction whatWrapper(rootNode) {\n    switch (rootNode) {\n    case 'td':\n    case 'th':\n        return 'tr';\n    case 'tr':\n        return 'table';\n    default:\n        return 'div';\n    }\n}\n\nfunction editMode(node, element, options) {\n    if (options && options.edit) {\n        element.setAttribute('data-skaryna-id', node.name);\n        node.__element = element;\n    }\n    return node;\n}\n\nfunction processChildren(element, options) {\n    if (!element || !element.childNodes) {\n        return Promise.resolve([]);\n    }\n    return Promise\n        .all(arraize(element.childNodes)\n            .map((child) => {\n                if (child.nodeType === 1 || child.nodeType === 3) {\n                    return fromHTML(child, options);\n                } else {\n                    return null;\n                }\n            }))\n        .then((items) => items.filter((item) => {\n            if (item.constructor === TextNode) {\n                return !item.absoluteEmpty;\n            }\n            return item !== null;\n        }));\n}\n\n/**\n * Parse POM JSON representation\n * @param   {string|HTMLElement}   model\n * @param   {options} options\n * @returns {Promise<Node>}\n */\nexport function fromHTML(input, options) {\n\n    if (!input) {\n        return Promise.resolve(null);\n    }\n\n    if (typeof input === 'string') {\n        if (input.length === 0) {\n            return Promise.resolve(null);\n        }\n        let wrapper = document.createElement(whatWrapper(input.replace('/^(\\s*)<([a-zA-Z0-9_-]+)', '$2').toLowerCase()));\n        wrapper.innerHTML = input;\n        return processChildren(wrapper, options)\n            .then((children) => {\n\n                if (children.length === 1) {\n                    return children[0];\n                }\n                if (children\n                    .filter((item) => !(item instanceof TextNode || item instanceof InlineNode))\n                    .length\n                ) {\n                    if (children.map((item) => item instanceof BlockNode).length) {\n                        return new Document(children.map((item) => {\n                            if (item.type === 'text') {\n                                return new Paragraph(item.text, item.formats, item.attrs, options);\n                            }\n                            return item;\n                        }));\n                    }\n                    return new Document(children);\n                }\n                let items = children.map((item) => {\n                        if (item instanceof InlineNode) {\n                            let [text, formats] = stringify([item]);\n                            return new TextNode(text, formats, options);\n                        }\n\n                        return item;\n                    }),\n                    first = items.shift();\n                items.forEach((item) => {\n                    first.append(item);\n                });\n                return first;\n            });\n    }\n    return parser.parse('html', input.nodeType === 3 ? 'text' : input.nodeName, input);\n}\n\nclass InlineNode extends BlockNode {\n\n}\n\nfunction formatType(item, text) {\n    if (item.type === 'A') {\n        return {\n            type: 'A',\n            title: item.attrs.title || text,\n            href: item.attrs.href\n        };\n    }\n    return item.type;\n}\n\nfunction stringify(items) {\n    let text = '',\n        formats = [],\n        index = 0;\n\n    items.forEach((item) => {\n        if (item instanceof InlineNode) {\n            let [innerText, innerFormats] = stringify(item.items),\n                format = {\n                    slice: [index, innerText.length],\n                    apply: [formatType(item, innerText)]\n                };\n            formats.push(format);\n            innerFormats.forEach((format) => {\n                formats.push({\n                    slice: [index + format.slice[0], format.slice[1]],\n                    apply: format.apply\n                });\n            });\n            formats.forEach((format) => {\n                formats.forEach((otherFormat, idx) => {\n                    if (format !== otherFormat && format.slice[0] === otherFormat.slice[0] && format.slice[1] === otherFormat.slice[1]) {\n                        format.apply = format.apply.concat(otherFormat.apply);\n                        formats.splice(idx, 1);\n                    }\n                });\n            });\n            text += innerText;\n            index += innerText.length;\n        } else if (item instanceof TextNode) {\n            text += item.text;\n            index += item.text.length;\n        } else {\n\n        }\n    });\n\n    return [text, formats];\n}\n\nfunction heading(token, data, options) {\n\n    return processChildren(data, options)\n        .then((items) => {\n            let [text, formats] = stringify(items);\n            return Promise.resolve(new Heading(token[1].toLowerCase(), text || '', formats.length ? formats : null, options));\n        });\n}\n\nfunction paragraph(token, data, options) {\n    return processChildren(data, options)\n        .then((items) => {\n            let [text, formats] = stringify(items);\n            return Promise.resolve(new Paragraph(text, formats.length ? formats : null));\n        });\n}\n\nfunction attributes(input) {\n    let output = null;\n    arraize(input)\n        .forEach((attribute) => {\n            output = output || {};\n            if (attribute.value && attribute.value.length) {\n                output[attribute.name] = attribute.value;\n            }\n        });\n    return output;\n\n}\n\nfunction ifAttr(value) {\n    if (value && value.length) {\n        return value;\n    }\n    return null;\n}\n\nfunction quote(token, data, options) {\n    return processChildren(data, options)\n        .then((items) => {\n\n            let paragraphs = [],\n                lastParagraph = [];\n            items.forEach((item) => {\n                if (item instanceof Paragraph) {\n                    if (lastParagraph.length) {\n                        let [text, formats] = stringify(items);\n                        paragraphs.push(Promise.resolve(new Paragraph(text, formats.length ? formats : null, options)));\n                        lastParagraph = [];\n                    }\n                    paragraphs.push(Promise.resolve(item));\n                } else {\n                    lastParagraph.push(item);\n                }\n            });\n            if (lastParagraph.length) {\n                let [text, formats] = stringify(items);\n                paragraphs.push(Promise.resolve(new Paragraph(text, formats.length ? formats : null, options)));\n            }\n\n            return Promise.all(paragraphs);\n        })\n        .then((items) => {\n            return Promise.resolve(new Quote(items));\n        });\n}\n\nparser.on('html', 'text', (token, data, options) => {\n    return Promise.resolve(new TextNode(data.textContent, null, options));\n});\nparser.on('html', 'H1', heading);\nparser.on('html', 'H2', heading);\nparser.on('html', 'H3', heading);\nparser.on('html', 'H4', heading);\nparser.on('html', 'H5', heading);\nparser.on('html', 'H6', heading);\nparser.on('html', 'P', paragraph);\nparser.on('html', 'BLOCKQUOTE', quote);\n\nparser.on('html', 'IMG', (token, data, options) => {\n    return Promise.resolve(new Image(data.src, ifAttr(data.getAttribute('title')), ifAttr(data.getAttribute('alt')), clone([attributes(data.attributes)], ['src', 'title', 'alt'])), options);\n});\n\n['ADDRESS', 'ARTICLE', 'ASIDE', 'DIV', 'FIGURE', 'FOOTER', 'HEADER', 'MAIN', 'NAV', 'SECTION'].forEach((nodeName) => {\n    parser.on('html', nodeName, (token, data, options) => {\n        return processChildren(data, options)\n            .then((items) => {\n                return Promise.resolve(new StaticBlockNode(token, items, attributes(data.attributes)), options);\n            });\n    });\n});\n\nparser.on('html', '*', (token, data, options) => {\n    return processChildren(data, options)\n        .then((items) => {\n            return Promise.resolve(new InlineNode(token, items, attributes(data.attributes)), options);\n        });\n});\n/*\nparser.on('html', '#text', (token, data) => {\n    return Promise.resolve(new TextNode(data.textContent));\n});\n\n[\n    ['b', 'strong'],\n    ['big', 'strong'],\n    ['i', 'em'],\n    'small',\n    ['tt', 'code'],\n    ['abbr', 'semantic', 'abbr'],\n    ['acronym', 'abbr', 'abbr'],\n    ['cite', 'semantic', 'cite'],\n    'code',\n    ['dfn', 'semantic', 'definition'],\n    'em',\n    ['time', 'semantic', 'time'],\n    ['var', 'code', 'var'],\n    ['kbd', 'code', 'kbd'],\n    'strong',\n    ['samp', 'code', 'sample'],\n    'bdo',\n    'a',\n    //'br',\n    //'img,\n    //'map',\n    //'object',\n    ['q', 'semantic', 'quotation'],\n    //script\n    'span',\n    del,\n    s\n    'sub',\n    'sup',\n    //button\n    //input\n    //label\n    //select\n    //textarea\n].forEach((inlineRule) => {\n\n    let input = typeof inlineRule === 'string' ? inlineRule : inlineRule[0];\n\n    parser.on('html', input, (token, data) => {\n        return processChildren(data)\n            .then((items) => {\n\n            });\n    });\n\n});\n*/\n","/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nimport {\n    parser\n}\nfrom './../parser';\n\nimport {\n    TextNode,\n    Document,\n    Heading,\n    Paragraph,\n    Image,\n    Fields,\n    Variants\n}\nfrom './../document';\n\n/**\n * Parse POM JSON representation\n * @param   {object}   model\n * @param   {options} options\n * @returns {Promise<Node>}\n */\nexport function fromPOM(model) {\n    if (!model) {\n        return Promise.resolve(null);\n    }\n    return parser.parse('pom', model.type, model);\n}\n\nfunction processChildNodes(items) {\n    if (!Array.isArray(items)) {\n        return Promise.resolve([]);\n    }\n    return Promise.all(items.map((item) => {\n        return fromPOM(item);\n    })).then((items) => {\n        return items.filter((item) => !!item);\n    });\n}\n\nparser.on('pom', 'document', (token, data) => {\n    return processChildNodes(data.items)\n        .then((items) => {\n            return new Document(items);\n        });\n});\n\nparser.on('pom', 'heading', (token, data) => {\n    return Promise.resolve(new Heading(data.level, data.text, data.formats, data.attrs));\n});\n\nparser.on('pom', 'paragraph', (token, data) => {\n    return Promise.resolve(new Paragraph(data.text, data.formats, data.attrs));\n});\n\nparser.on('pom', 'text', (token, data) => {\n    return Promise.resolve(new TextNode(data.text, data.formats));\n});\n\nparser.on('pom', 'image', (token, data) => {\n    return Promise.resolve(new Image(data.src, data.title, data.alt));\n});\n\nparser.on('pom', 'Fields', (token, data) => {\n    let fields = {};\n    return Promise.all(Object\n            .keys(data)\n            .filter((key) => key !== 'type')\n            .map((key) => {\n                return fromPOM(data[key])\n                    .then((POM) => {\n                        fields[key] = POM;\n                    });\n            }))\n        .then(() => {\n            return Promise.resolve(new Fields(fields));\n        });\n});\n\nparser.on('pom', 'Variants', (token, data) => {\n    let variants = {};\n    return Promise.all(Object\n            .keys(data)\n            .filter((key) => key !== 'type')\n            .map((key) => {\n                return fromPOM(data[key])\n                    .then((POM) => {\n                        variants[key] = POM;\n                    });\n            }))\n        .then(() => {\n            return Promise.resolve(new Variants(variants));\n        });\n});\n","/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nimport {\n    Event, Emitter\n}\nfrom './emitter';\n\nexport const CHANGE = 'change';\nexport const DEFAULT_DOCUMENT = '#default';\n\nclass Repository extends Emitter {\n\n    constructor() {\n        super();\n        this._documents = {};\n    }\n\n    get main() {\n        return this._documents[DEFAULT_DOCUMENT];\n    }\n\n    get(documentId) {\n        if (this._documents[documentId]) {\n            return this._documents[documentId].content;\n        }\n    }\n\n    set(documentId, value) {\n        this._documents[documentId] = {\n            content: value\n        };\n        this.emit(CHANGE, {\n            id: documentId\n        });\n    }\n\n    has(documentId) {\n        return !!this._documents[documentId];\n    }\n\n    toJSON() {\n        let data = {};\n        Object\n            .keys(this._documents)\n            .forEach((key) => {\n                //console.log(this._documents[key].content);\n                data[key] = {\n                    id: key,\n                    content: this._documents[key].content.toJSON()\n                };\n            });\n        return data;\n    }\n}\n\n\nexport var repository = new Repository();\n","/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nclass Serializer {\n\n    serialize(format, node, options) {\n\n        if (!node) {\n            return Promise.reject(new Error('Model is empty'));\n        }\n\n        if (!node.type) {\n            return Promise.reject(new Error('Undefined node type'));\n        }\n\n        return this.handle(format, node.type, node, options);\n    }\n\n    on(format, nodeType, handler) {\n        this._handlers = this._handlers || {};\n        this._handlers[format] = this._handlers[format] || {};\n        this._handlers[format][nodeType] = handler;\n    }\n\n    handle(format, nodeType, node, options) {\n\n        let handler = (this._handlers && this._handlers[format] && this._handlers[format][nodeType]) ? this._handlers[format][nodeType] : null;\n        if (!handler) {\n            handler = (this._handlers && this._handlers[format] && this._handlers[format]['*']) ? this._handlers[format]['*'] : null;\n            if (!handler) {\n                return Promise.reject(new Error('No handler defined for ' + format + ' : ' + nodeType));\n            }\n        }\n        return handler(node, options)\n            .then((html) => {\n                return html;\n            });\n    }\n\n    handleContents(format, array, options) {\n        let self = this;\n        return Promise\n            .all(array.map((content) => {\n                return self.serialize('html', content, options);\n            }));\n\n    }\n}\n\nexport var serializer = new Serializer();\n","/* jslint esnext:true, node:true */\n/* globals document */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nimport {\n    serializer\n}\nfrom './../serializer';\n\nimport {\n    TextNode\n}\nfrom './../document';\nimport {\n    arraize\n}\nfrom './../util';\n\nexport function toHTML(model, options) {\n    return serializer.serialize('html', model, options);\n}\n\nfunction otherAttrs(object, except) {\n    let result = {};\n    Object\n        .keys(object)\n        .filter((key) => {\n            return except.indexOf(key) === -1;\n        })\n        .forEach((key) => {\n            result[key] = object[key];\n        });\n    return result;\n}\n\nfunction format(string, formats) {\n    let wrapper = document.createElement('p'),\n        slices = string.split('').map((char) => {\n            return {\n                char: char,\n                apply: []\n            };\n        });\n\n    slices.push({\n        char: '',\n        apply: []\n    });\n\n    console.log(string);\n\n    formats.forEach((format) => {\n        let from = format.slice[0],\n            to = from + format.slice[1];\n\n        console.log(from, to, slices.length);\n\n        format.apply.forEach((apply) => {\n            if (slices[from].apply.indexOf(apply) == -1) {\n                slices[from].apply.push(apply);\n            }\n            if (slices[to].apply.indexOf('/' + apply) == -1) {\n                slices[to].apply.push('/' + apply);\n            }\n        });\n    });\n    wrapper.innerHTML = slices.map((char) => {\n        return char.apply.map((tag) => '<' + tag + '>').join('') + char.char;\n    }).join('');\n    return arraize(wrapper.childNodes);\n}\n\nexport function element(node, nodeType, attributes, content, options) {\n\n    let promise;\n\n    if (content) {\n\n        promise = serializer.handleContents('html', content || [], options);\n    } else {\n        promise = Promise.resolve(null);\n    }\n\n    return promise.then((content) => {\n\n        if (node.formats && node.formats.length) {\n            content = format(content[0].nodeValue, node.formats);\n        }\n\n        let elem = document.createElement(nodeType);\n        if (options && options.edit) {\n            elem.setAttribute('data-skaryna-id', node.name);\n        }\n        if (attributes) {\n            Object\n                .keys(attributes)\n                .forEach((attributeName) => {\n                    elem.setAttribute(attributeName, attributes[attributeName]);\n                });\n        }\n        if (Array.isArray(content)) {\n            content.forEach((child) => elem.appendChild(child));\n        }\n        return elem;\n    });\n}\n\nclass FakeDoc {\n\n    constructor() {\n        this.children = [];\n    }\n\n    appendChild(child) {\n        this.children.push(child);\n    }\n\n    get outerHTML() {\n        let str = '';\n        this.children.forEach((child) => {\n            if (child.nodeType === 1) {\n                str += child.outerHTML;\n            } else {\n                str += child.textContent;\n            }\n        });\n        return str;\n    }\n}\n\nserializer.on('html', 'document', (node, options) => {\n    return serializer\n        .handleContents('html', node.items || [], options)\n        .then((contents) => {\n            let output = new FakeDoc();\n            if (Array.isArray(contents)) {\n                contents.forEach((child) => output.appendChild(child));\n            }\n            return output;\n        });\n});\n\nserializer.on('html', 'heading', (node, options) => {\n    return element(node, 'h' + (node.level || 1), node.attr(), [new TextNode(node.text, node.formats)], options);\n});\n\nserializer.on('html', 'paragraph', (node, options) => {\n    return element(node, 'p', node.attr(), [new TextNode(node.text, node.formats)], options);\n});\n\nserializer.on('html', 'image', (node, options) => {\n    return element(node, 'img', node.attr(), null, options);\n});\n\nserializer.on('html', 'text', (node, options) => {\n    let element = document.createTextNode(node.text);\n    if (options && options.edit) {\n        //element.setAttribute('name', node.name);\n    }\n    return Promise.resolve(element);\n});\n\nserializer.on('html', '*', (node, options) => {\n    return element(node, node._type, node.attr(), node.items, options);\n});\n","/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\nexport class Toolbar {\n\n    constructor() {\n        //super();\n\n        this.element = document.createElement('div');\n        this.element.setAttribute('data-skaryna-toolbar', '');\n        this.element.innerHTML = '<div data-skaryna-toolbar-actions>aaaaaaaaa</div><div data-skaryna-toolbar-arrow><span></span></div>';\n        this.arrow = this.element.querySelector('[data-skaryna-toolbar-arrow]');\n\n        let styles = document.createElement('style');\n        styles.innerText = `\n            [data-skaryna-toolbar] {\n                position: absolute;\n                visibility: hidden;\n                display: none;\n                z-index: 10000;\n                transition: none;\n                top: 0;\n                left: 0;\n            }\n\n            [data-skaryna-toolbar-actions] {\n                position: relative;\n                background-image: linear-gradient(to bottom,rgba(49,49,47,.99),#262625);\n                background-repeat: repeat-x;\n                border-radius: 5px;\n            }\n\n            [data-skaryna-toolbar-arrow] {\n                position: absolute;\n                bottom: -10px;\n                left: 50%;\n                clip: rect(10px 20px 20px 0);\n                margin-left: -10px;\n            }\n\n            [data-skaryna-toolbar-arrow] > span {\n                display: block;\n                width: 20px;\n                height: 20px;\n                background-color: #262625;\n                transform: rotate(45deg) scale(.5);\n            }\n            `;\n\n        document.body.appendChild(styles);\n        document.body.appendChild(this.element);\n    }\n\n    getSelectionCoords(theWindow) {\n        let win = theWindow || window,\n            doc = win.document,\n            sel = doc.selection,\n            range, rects, rect,\n            x = 0,\n            y = 0;\n        if (sel) {\n            if (sel.type != \"Control\") {\n                range = sel.createRange();\n                range.collapse(true);\n                x = range.boundingLeft;\n                y = range.boundingTop;\n            }\n        } else if (win.getSelection) {\n            sel = win.getSelection();\n            if (sel.rangeCount) {\n                range = sel.getRangeAt(0).cloneRange();\n                if (range.getClientRects) {\n                    range.collapse(true);\n                    rects = range.getClientRects();\n\n                    if (rects.length > 0) {\n                        rect = rects[0];\n                    }\n                    x = rect.left;\n                    y = rect.top;\n                }\n                // Fall back to inserting a temporary element\n                if (x == 0 && y == 0) {\n                    var span = doc.createElement(\"span\");\n                    if (span.getClientRects) {\n                        // Ensure span has dimensions and position by\n                        // adding a zero-width space character\n                        span.appendChild(doc.createTextNode(\"\\u200b\"));\n                        range.insertNode(span);\n                        rect = span.getClientRects()[0];\n                        x = rect.left;\n                        y = rect.top;\n                        var spanParent = span.parentNode;\n                        spanParent.removeChild(span);\n\n                        // Glue any broken text nodes back together\n                        spanParent.normalize();\n                    }\n                }\n            }\n        }\n        return {\n            x: x,\n            y: y\n        };\n    }\n\n    anchor() {\n        let coords = this.getSelectionCoords(),\n            self = this,\n            rect,\n            arrow;\n        this.element.style.display = 'block';\n        this.element.style.visibility = 'visible';\n\n        setTimeout(() => {\n            rect = this.element.getBoundingClientRect();\n            arrow = this.arrow.getBoundingClientRect();\n            console.log(rect, coords, arrow);\n            this.show(coords.x, coords.y - rect.height - 10);\n        }, 1);\n    }\n\n    show(x, y) {\n        this.element.style.top = y + 'px';\n        this.element.style.left = x + 'px';\n    }\n    hide() {\n        this.element.style.display = null;\n        this.element.style.visibility = null;\n    }\n}\n","/* jslint esnext:true, node:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\n\n/**\n * Convert iterable objects into arrays\n * @param   {Iterable} iterable\n * @returns {Array}\n */\nexport function arraize(iterable) {\n    return [].slice.apply(iterable);\n}\n\nexport function clone(inputs, except) {\n    let result = {};\n    inputs\n        .forEach((input) => {\n            if (typeof input !== 'object') {\n                return;\n            }\n            Object\n                .keys(input)\n                .forEach((key) => {\n                    if (except && except.indexOf(key) !== -1) {\n                        return;\n                    }\n                    result[key] = JSON.parse(JSON.stringify(input[key]));\n                });\n        });\n    return result;\n}\n","/* jslint esnext:true, node:true, browser:true */\n/**\n    The MIT License (MIT)\n\n    Copyright (c) 2016 Łukasz Marek Sielski\n\n    Permission is hereby granted, free of charge, to any person obtaining a copy\n    of this software and associated documentation files (the \"Software\"), to deal\n    in the Software without restriction, including without limitation the rights\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the Software is\n    furnished to do so, subject to the following conditions:\n\n    The above copyright notice and this permission notice shall be included in all\n    copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n    SOFTWARE.\n*/\nexport class XHR {\n  static ajax(path, method, data, raw) {\n\n    return new Promise((resolve, reject) => {\n\n      let xhr = new XMLHttpRequest(),\n        httpMethod = method.toLowerCase();\n\n      xhr.open(httpMethod, path);\n      if (httpMethod === 'post' || httpMethod === 'put') {\n        xhr.setRequestHeader('Content-type', 'application/json');\n      }\n\n      xhr.onreadystatechange = () => {\n        let DONE = 4, // readyState 4 means the request is done.\n          OK = 200; // status 200 is a successful return.\n        if (xhr.readyState === DONE) {\n          if (xhr.status === OK) {\n            resolve(xhr.responseText); // 'This is the returned text.'\n          } else if (xhr.status === '204') {\n            resolve(null);\n          } else {\n            reject(new Error('Error: ' + xhr.status)); // An error occurred during the request.\n          }\n        }\n      };\n\n      xhr.send(data ? (raw ? data : JSON.stringify(data)) : null);\n\n    });\n  }\n  static get(path, raw) {\n    return XHR.ajax(path, 'get', null, raw);\n  }\n  static post(path, data, raw) {\n    return XHR.ajax(path, 'post', data, raw);\n  }\n  static put(path, data, raw) {\n    return XHR.ajax(path, 'put', data, raw);\n  }\n  static delete(path, raw) {\n    return XHR.ajax(path, 'delete', null, raw);\n  }\n}\n"],"sourceRoot":"/source/"}